{% extends "base.html" %}

{% block title %}{{ title }}{% endblock %}

{% block extra_css %}
<style>
    .capability-container {
        display: flex;
        gap: 20px;
        height: calc(100vh - 200px);
        min-height: 600px;
    }

    .student-list-panel {
        width: 30%;
        min-width: 280px;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: white;
        overflow: hidden;
        display: flex;
        flex-direction: column;
    }

    .panel-header {
        padding: 15px;
        background: #f8f9fa;
        border-bottom: 1px solid #ddd;
        font-weight: bold;
        font-size: 1.1em;
    }

    .student-list {
        flex: 1 1 0;
        /* ä½¿ç”¨0ä½œä¸ºåŸºå‡†,å¼ºåˆ¶å¡«å……å‰©ä½™ç©ºé—´ */
        overflow-y: auto;
        padding: 10px;
        min-height: 0;
        /* å…è®¸flexæ­£ç¡®è®¡ç®— */
    }

    .student-item {
        padding: 12px;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        margin-bottom: 8px;
        cursor: pointer;
        transition: all 0.2s;
        background: white;
    }

    .student-item:hover {
        background: #f0f8ff;
        border-color: #007bff;
        transform: translateX(5px);
    }

    .student-item.active {
        background: #007bff;
        color: white;
        border-color: #0056b3;
    }

    /* å…³é”®äººå‘˜æ ‡çº¢ */
    .student-item.key-personnel {
        border-left: 4px solid #dc3545;
        background: #fff5f5;
    }

    .student-item.key-personnel.active {
        background: #dc3545;
        border-color: #bd2130;
    }

    .student-item.active .student-score {
        color: #ffeb3b;
    }

    .student-name {
        font-weight: bold;
        margin-bottom: 4px;
    }

    /* å…³é”®äººå‘˜åå­—æ ‡çº¢ */
    .student-item.key-personnel .student-name {
        color: #dc3545;
    }

    .student-item.key-personnel.active .student-name {
        color: #fff;
    }

    .student-meta {
        font-size: 0.85em;
        color: #666;
        display: flex;
        justify-content: space-between;
    }

    .student-item.active .student-meta {
        color: rgba(255, 255, 255, 0.9);
    }

    .student-score {
        font-weight: bold;
        color: #007bff;
    }

    .charts-panel {
        flex: 1;
        border: 1px solid #ddd;
        border-radius: 8px;
        background: white;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
        overflow-y: auto;
        /* æ·»åŠ æ»šåŠ¨æ¡ */
    }

    .chart-container {
        flex: 1;
        min-height: 0;
        border: 1px solid #e0e0e0;
        border-radius: 6px;
        padding: 15px;
        display: flex;
        flex-direction: column;
    }

    .chart-title {
        font-weight: 600;
        font-size: 1.1em;
        margin-bottom: 15px;
        color: #333;
        text-align: center;
    }

    .chart-canvas-wrapper {
        flex: 1;
        position: relative;
        min-height: 0;
    }

    .loading {
        text-align: center;
        padding: 20px;
        color: #999;
    }

    .no-data {
        text-align: center;
        padding: 40px;
        color: #999;
        font-size: 1.1em;
    }

    /* å“åº”å¼ - å¹³æ¿è®¾å¤‡ */
    @media (max-width: 1024px) {
        .capability-container {
            flex-direction: column;
            height: auto;
        }

        .student-list-panel {
            width: 100%;
            /* ç§»é™¤max-heighté™åˆ¶,è®©é¢æ¿è‡ªç”±æ‰©å±• */
        }

        .charts-panel {
            min-height: 800px;
        }
    }

    /* ç§»åŠ¨ç«¯æ±‰å ¡èœå•æŒ‰é’® */
    .mobile-menu-toggle {
        display: none;
        position: fixed;
        top: 80px;
        left: 15px;
        z-index: 1001;
        background: #007bff;
        color: white;
        border: none;
        border-radius: 8px;
        width: 48px;
        height: 48px;
        box-shadow: 0 4px 12px rgba(0, 123, 255, 0.3);
        cursor: pointer;
        transition: all 0.3s;
    }

    .mobile-menu-toggle:hover {
        background: #0056b3;
        transform: scale(1.05);
    }

    .mobile-menu-toggle:active {
        transform: scale(0.95);
    }

    /* æ±‰å ¡å›¾æ ‡ */
    .hamburger-icon {
        display: flex;
        flex-direction: column;
        gap: 4px;
        align-items: center;
        justify-content: center;
    }

    .hamburger-icon span {
        display: block;
        width: 20px;
        height: 2px;
        background: white;
        border-radius: 2px;
        transition: all 0.3s;
    }

    /* é®ç½©å±‚ */
    .sidebar-overlay {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(0, 0, 0, 0.5);
        z-index: 999;
        opacity: 0;
        transition: opacity 0.3s;
    }

    .sidebar-overlay.show {
        display: block;
        opacity: 1;
    }

    /* å“åº”å¼ - æ‰‹æœºè®¾å¤‡ */
    @media (max-width: 768px) {

        /* æ˜¾ç¤ºæ±‰å ¡èœå•æŒ‰é’® */
        .mobile-menu-toggle {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ä¾§è¾¹æ æŠ½å±‰æ ·å¼ */
        .student-list-panel {
            position: fixed;
            top: 0;
            /* ä»å±å¹•é¡¶éƒ¨å¼€å§‹ */
            left: 0;
            bottom: 0;
            width: 85%;
            max-width: 320px;
            /* ä½¿ç”¨CSSå˜é‡å­˜å‚¨çœŸå®è§†å£é«˜åº¦,è§£å†³æ‰‹æœºæµè§ˆå™¨åœ°å€æ é—®é¢˜ */
            height: calc(var(--vh, 1vh) * 100);
            max-height: calc(var(--vh, 1vh) * 100);
            z-index: 1050;
            /* æé«˜z-index,é«˜äºæ±‰å ¡èœå•æŒ‰é’® */
            transform: translateX(-100%);
            transition: transform 0.3s ease-in-out;
            box-shadow: 2px 0 12px rgba(0, 0, 0, 0.15);
        }

        .student-list-panel.show {
            transform: translateX(0);
        }

        /* å¼ºåˆ¶ä¾§è¾¹æ ä½¿ç”¨flexå¸ƒå±€ */
        .student-list-panel {
            display: flex !important;
            flex-direction: column !important;
        }

        /* é¡¶éƒ¨æ ‡é¢˜åŒºåŸŸ - å›ºå®šé«˜åº¦ */
        .student-list-panel .panel-header {
            flex-shrink: 0;
            padding: 12px 15px;
        }

        /* ç­›é€‰å™¨åŒºåŸŸ - å›ºå®šé«˜åº¦,ä¸è¢«å‹ç¼© */
        .student-list-panel>div[style*="padding"] {
            flex-shrink: 0;
            max-height: 45vh;
            /* æœ€å¤šå æ®45%è§†å£é«˜åº¦ */
            overflow-y: auto;
            /* å¦‚æœç­›é€‰å™¨è¿‡é•¿åˆ™æ»šåŠ¨ */
        }

        /* å…³é”®äººå‘˜å›¾ä¾‹ - å›ºå®šé«˜åº¦ */
        .student-list-panel .key-personnel-legend {
            flex-shrink: 0;
            padding: 6px 10px;
            font-size: 0.75em;
        }

        /* ç¡®ä¿äººå‘˜åˆ—è¡¨åŒºåŸŸå¡«å……å‰©ä½™ç©ºé—´ */
        .student-list-panel .student-list {
            flex: 1 1 0 !important;
            /* ä½¿ç”¨0ä½œä¸ºåŸºå‡†,å¼ºåˆ¶å¡«å…… */
            min-height: 0 !important;
            /* å…è®¸flexæ­£ç¡®è®¡ç®— */
            overflow-y: auto !important;
            -webkit-overflow-scrolling: touch;
            /* iOSå¹³æ»‘æ»šåŠ¨ */
        }

        /* ä¼˜åŒ–ç­›é€‰å™¨åŒºåŸŸå†…è¾¹è· */
        .student-list-panel>div[style*="padding: 15px"] {
            padding: 10px !important;
        }

        /* å‹ç¼©è¡¨å•é—´è· */
        .student-list-panel .mb-3 {
            margin-bottom: 0.75rem !important;
        }

        /* ä¼˜åŒ–å›¾ä¾‹ */
        .key-personnel-legend {
            padding: 8px 12px;
            font-size: 0.8em;
            margin-bottom: 8px;
        }

        /* å›¾è¡¨åŒºåŸŸå æ»¡å®½åº¦ */
        .charts-panel {
            width: 100%;
            min-height: auto;
        }
    }

    /* å“åº”å¼ - å°å±æ‰‹æœº */
    @media (max-width: 576px) {
        /* ç§»åŠ¨ç«¯ä½¿ç”¨fixedå®šä½,ä¸éœ€è¦é¢å¤–çš„max-heighté™åˆ¶ */

        .student-list-panel>div[style*="padding"] {
            padding: 8px !important;
        }

        .student-list-panel .mb-3 {
            margin-bottom: 0.5rem !important;
        }

        .key-personnel-legend {
            padding: 6px 10px;
            font-size: 0.75em;
        }

        /* ä¼˜åŒ–äººå‘˜åˆ—è¡¨é¡¹ */
        .student-item {
            padding: 10px;
            margin-bottom: 6px;
        }
    }


    /* å…³é”®äººå‘˜å›¾ä¾‹ */
    .key-personnel-legend {
        padding: 10px 15px;
        background: #fff5f5;
        border: 1px solid #ffcdd2;
        border-radius: 4px;
        margin-bottom: 10px;
        font-size: 0.85em;
    }

    .key-personnel-legend .legend-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .key-personnel-legend .legend-marker {
        width: 16px;
        height: 16px;
        background: #dc3545;
        border-radius: 2px;
    }
</style>
{% endblock %}

{% block content %}
<!-- ç§»åŠ¨ç«¯æ±‰å ¡èœå•æŒ‰é’® -->
<button class="mobile-menu-toggle" id="mobileMenuToggle" onclick="toggleSidebar()">
    <div class="hamburger-icon">
        <span></span>
        <span></span>
        <span></span>
    </div>
</button>

<!-- ä¾§è¾¹æ é®ç½©å±‚ -->
<div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-3">
        <div>
            <h2>ä¸ªäººç»¼åˆèƒ½åŠ›ç”»åƒ <span id="pageDateRange" class="badge bg-primary"
                    style="font-size: 0.5em; vertical-align: middle;"></span></h2>
            <p class="text-muted mb-0">æ•´åˆäººå‘˜ã€åŸ¹è®­ã€å®‰å…¨ã€ç»©æ•ˆæ•°æ®çš„äº”ç»´èƒ½åŠ›è¯„ä¼°(æŒ‰æƒé™åˆ†çº§)</p>
        </div>
        <a href="{{ url_for('personnel.dashboard') }}" class="btn btn-secondary">è¿”å›</a>
    </div>

    <div class="capability-container">
        <!-- å·¦ä¾§:å­¦å‘˜åˆ—è¡¨ + ç­›é€‰å™¨ -->
        <div class="student-list-panel" id="studentListPanel">
            <div class="panel-header">
                äººå‘˜åˆ—è¡¨ (æŒ‰ç»¼åˆåˆ†å‡åº)
            </div>

            <!-- ç­›é€‰å™¨åŒºåŸŸ -->
            <div style="padding: 15px; background: #f8f9fa; border-bottom: 1px solid #ddd;">
                <div class="mb-3">
                    <label class="form-label" style="font-size: 0.85em; font-weight: 600;">æ—¥æœŸèŒƒå›´</label>
                    <div class="row g-2">
                        {% set start_date_id = 'filterStartDate' %}
                        {% set end_date_id = 'filterEndDate' %}
                        {% set col_class = 'col-6' %}
                        {% set labels = false %}
                        {% set show_quick_buttons = true %}
                        {% include 'components/month_filter.html' %}
                    </div>
                </div>

                <div class="mb-3">
                    <label class="form-label" style="font-size: 0.85em; font-weight: 600;">éƒ¨é—¨</label>
                    <select class="form-select form-select-sm" id="filterDepartment">
                        <option value="">å…¨éƒ¨éƒ¨é—¨</option>
                    </select>
                </div>

                <div class="mb-3">
                    <label class="form-label" style="font-size: 0.85em; font-weight: 600;">å²—ä½</label>
                    <input type="text" class="form-control form-control-sm" id="filterPosition" placeholder="è¾“å…¥å²—ä½å…³é”®è¯">
                </div>

                <div class="d-flex gap-2">
                    <button class="btn btn-primary btn-sm flex-fill" onclick="applyFilters()">åº”ç”¨ç­›é€‰</button>
                    <button class="btn btn-secondary btn-sm flex-fill" onclick="resetFilters()">é‡ç½®</button>
                </div>
            </div>

            <!-- å…³é”®äººå‘˜å›¾ä¾‹ -->
            <div class="key-personnel-legend">
                <div class="legend-item">
                    <span class="legend-marker"></span>
                    <span id="keyPersonnelLegend">åŠ è½½ä¸­...</span>
                </div>
            </div>

            <div class="student-list" id="studentList">
                <div class="loading">åŠ è½½ä¸­...</div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šå›¾è¡¨åŒºåŸŸ -->
        <div class="charts-panel">
            <div style="flex: 1; display: flex; flex-direction: column; gap: 20px; padding-top: 15px;">
                <!-- ç»¼åˆåˆ†æ•°å¡ç‰‡ -->
                <div class="row g-3" id="scoreCards">
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body p-2">
                                <h6 class="card-title text-muted mb-1" style="font-size: 0.9em;">ç»¼åˆè¯„åˆ†</h6>
                                <h3 class="mb-0" id="scoreComprehensive">--</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body p-2">
                                <h6 class="card-title text-muted mb-1" style="font-size: 0.9em;">åŸ¹è®­èƒ½åŠ›</h6>
                                <h3 class="mb-0 text-primary" id="scoreTraining">--</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body p-2">
                                <h6 class="card-title text-muted mb-1" style="font-size: 0.9em;">å®‰å…¨æ„è¯†</h6>
                                <h3 class="mb-0 text-success" id="scoreSafety">--</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body p-2">
                                <h6 class="card-title text-muted mb-1" style="font-size: 0.9em;">å·¥ä½œç»©æ•ˆ</h6>
                                <h3 class="mb-0 text-warning" id="scorePerformance">--</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body p-2">
                                <h6 class="card-title text-muted mb-1" style="font-size: 0.9em;">å®‰å…¨è¶‹åŠ¿</h6>
                                <h3 class="mb-0 text-info" id="scoreLearning">--</h3>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-2">
                        <div class="card text-center">
                            <div class="card-body p-2">
                                <h6 class="card-title text-muted mb-1" style="font-size: 0.9em;">ç¨³å®šæ€§</h6>
                                <h3 class="mb-0 text-secondary" id="scoreStability">--</h3>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- äº”ç»´èƒ½åŠ›é›·è¾¾å›¾ -->
                <div class="chart-container" style="flex: 1;">
                    <div class="chart-title">äº”ç»´èƒ½åŠ›é›·è¾¾å›¾</div>
                    <div class="chart-canvas-wrapper">
                        <canvas id="comprehensiveRadar"></canvas>
                    </div>
                </div>

                <!-- äº”ä¸ªæ¨¡å—çš„ç»Ÿè®¡æ•°æ® -->
                <div class="row g-3">
                    <div class="col-md-4 col-lg">
                        <div class="card h-100">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <strong>ç¨³å®šåº¦</strong>
                                <span id="stabilityAlertBadge" class="badge bg-success">âœ… ç¨³å®š</span>
                            </div>
                            <div class="card-body" id="stabilityStats">
                                <p class="mb-1"><span class="text-muted">ç¨³å®šåº¦åˆ†å€¼:</span> <span class="text-secondary"
                                        id="stabilityScoreValue">--</span> åˆ†</p>
                                <p class="mb-1"><span class="text-muted">åŸºç¡€æ‰£åˆ†:</span> <span
                                        id="stabilityBaseDeduction">--</span> åˆ†</p>
                                <p class="mb-1"><span class="text-muted">çº¢çº¿è¿è§„:</span> <span class="text-danger"
                                        id="stabilityRedlineCount">--</span> æ¬¡</p>
                                <p class="mb-1"><span class="text-muted">æ³¢åŠ¨ç†”æ–­:</span> <span
                                        id="stabilityCvCapped">--</span></p>
                                <p class="mb-0"><span class="text-muted">å®‰å…¨CV:</span> <span
                                        id="stabilitySafetyCv">--</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg">
                        <div class="card h-100">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <strong>å®‰å…¨è®°å½•</strong>
                                <span id="safetyAlertBadge" class="badge bg-success">âœ… å®‰å…¨</span>
                            </div>
                            <div class="card-body" id="safetyStats">
                                <p class="mb-1"><span class="text-muted">è¿è§„æ¬¡æ•°:</span> <span class="text-danger"
                                        id="safetyViolations">--</span></p>
                                <p class="mb-1"><span class="text-muted">ç´¯è®¡æ‰£åˆ†:</span> <span class="text-danger"
                                        id="safetyDeduction">--</span></p>
                                <p class="mb-1"><span class="text-muted">æœˆå‡é¢‘æ¬¡:</span> <span id="safetyAvgFreq">--</span>
                                </p>
                                <p class="mb-1"><span class="text-muted">è¡Œä¸ºåˆ†(A):</span> <span
                                        id="safetyScoreA">--</span></p>
                                <p class="mb-1"><span class="text-muted">ä¸¥é‡åˆ†(B):</span> <span
                                        id="safetyScoreB">--</span></p>
                                <p class="mb-1"><span class="text-muted">å‘ç°é—®é¢˜:</span> <span
                                        id="safetyInspector">--</span></p>
                                <p class="mb-0"><span class="text-muted">æ•´æ”¹æ¬¡æ•°:</span> <span
                                        id="safetyRectifier">--</span></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg">
                        <div class="card h-100">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <strong>åŸ¹è®­èƒ½åŠ›</strong>
                                <span id="trainingAlertBadge" class="badge bg-success">âœ… èƒ½åŠ›è¾¾æ ‡</span>
                            </div>
                            <div class="card-body" id="trainingStats">
                                <p class="mb-1"><span class="text-muted">é›·è¾¾åˆ†å€¼:</span> <span class="text-primary"
                                        id="trainingRadarScore">--</span> åˆ†</p>
                                <p class="mb-1"><span class="text-muted">åŸå§‹åŸºç¡€åˆ†:</span> <span
                                        id="trainingOriginalScore">--</span> åˆ†</p>
                                <p class="mb-1"><span class="text-muted">æƒ©ç½šç³»æ•°:</span> <span
                                        id="trainingCoefficient">--</span></p>
                                <p class="mb-1"><span class="text-muted">æ“ä½œæ€»æ•°:</span> <span
                                        id="totalTrainings">--</span> æ¬¡</p>
                                <p class="mb-0"><span class="text-muted">å¤±æ ¼æ¬¡æ•°:</span> <span
                                        id="trainingFailCount">--</span> æ¬¡</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg">
                        <div class="card h-100">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <strong>ç»©æ•ˆæ•°æ®</strong>
                                <span id="performanceAlertBadge" class="badge bg-success">âœ… è¾¾æ ‡</span>
                            </div>
                            <div class="card-body" id="performanceStats">
                                <p class="mb-1"><span class="text-muted">ç»©æ•ˆåˆ†å€¼:</span> <span class="text-warning"
                                        id="recentPerformance">--</span> åˆ†</p>
                                <p class="mb-1"><span class="text-muted">ç­‰çº§æ ‡ç­¾:</span> <span
                                        id="performanceLabel">--</span></p>
                                <p class="mb-1"><span class="text-muted">ç»Ÿè®¡æ¨¡å¼:</span> <span
                                        id="performanceMode">--</span></p>
                                <p class="mb-1"><span class="text-muted">ç»Ÿè®¡èŒƒå›´:</span> <span
                                        id="performanceRange">--</span></p>
                                <p class="mb-0"><span class="text-muted">è®°å½•æ•°:</span> <span
                                        id="performanceCount">--</span> æ¡</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-4 col-lg">
                        <div class="card h-100">
                            <div class="card-header bg-light d-flex justify-content-between align-items-center">
                                <strong>å®‰å…¨è¶‹åŠ¿</strong>
                                <span id="learningAlertBadge" class="badge bg-success">âœ… ç¨³å®š</span>
                            </div>
                            <div class="card-body" id="learningStats">
                                <p class="mb-1"><span class="text-muted">è¶‹åŠ¿åˆ†å€¼:</span> <span class="text-info"
                                        id="learningScoreValue">--</span> åˆ†</p>
                                <p class="mb-1"><span class="text-muted">é£é™©ç­‰çº§:</span> <span id="learningTier">--</span>
                                </p>
                                <p class="mb-1"><span class="text-muted">æƒ¯æ€§æ‰£å‡:</span> <span class="text-danger fw-bold"
                                        id="learningInertiaRate">--</span>
                                </p>
                                <p class="mb-1"><span class="text-muted">è¿ç»­é«˜å±:</span> <span
                                        id="learningConsecutive">--</span>
                                </p>
                                <p class="mb-1"><span class="text-muted">åŸºç¡€å¾—åˆ†:</span> <span
                                        id="learningBaseScore">--</span> åˆ†
                                </p>
                                <p class="mb-0"><span class="text-muted">ç»Ÿè®¡æœˆæ•°:</span> <span
                                        id="learningMonths">--</span> æœˆ</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block extra_js %}
<!-- å¼•å…¥ Chart.js å’Œ Annotation æ’ä»¶ -->
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script
    src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@3.0.1/dist/chartjs-plugin-annotation.min.js"></script>

<!-- å¼•å…¥æ—¥æœŸç­›é€‰å™¨åº“ -->
<script src="{{ url_for('static', filename='js/date-filter.js') }}"></script>

<script>
    let students = [];
    let allStudents = [];  // å­˜å‚¨æ‰€æœ‰å­¦å‘˜æ•°æ®
    let selectedStudent = null;
    let comprehensiveRadarChart = null;
    let departments = [];  // å­˜å‚¨éƒ¨é—¨åˆ—è¡¨
    let keyPersonnelConfig = {  // å…³é”®äººå‘˜é…ç½®ï¼ˆä»åç«¯åŠ¨æ€åŠ è½½ï¼‰
        comprehensive_threshold: 75,
        monthly_violation_threshold: 3
    };

    // åŠ è½½å…³é”®äººå‘˜é…ç½®
    async function loadKeyPersonnelConfig() {
        try {
            const response = await fetch('/personnel/api/key-personnel-config');
            const data = await response.json();
            if (data.success) {
                keyPersonnelConfig = data.config;
                console.log('å…³é”®äººå‘˜é…ç½®å·²åŠ è½½:', keyPersonnelConfig);
                // åŠ è½½é…ç½®åæ›´æ–°å›¾ä¾‹
                updateKeyPersonnelLegend();
            }
        } catch (error) {
            console.error('åŠ è½½å…³é”®äººå‘˜é…ç½®å¤±è´¥ï¼Œä½¿ç”¨é»˜è®¤å€¼:', error);
        }
    }

    // åŠ è½½éƒ¨é—¨åˆ—è¡¨
    async function loadDepartments() {
        try {
            const response = await fetch('/personnel/api/students-list');
            if (!response.ok) throw new Error('è·å–éƒ¨é—¨å¤±è´¥');

            const studentsList = await response.json();
            const deptSet = new Set();
            studentsList.forEach(s => {
                if (s.department_name) {
                    deptSet.add(s.department_name);
                }
            });

            departments = Array.from(deptSet).sort();

            // å¡«å……éƒ¨é—¨ä¸‹æ‹‰æ¡†
            const deptSelect = document.getElementById('filterDepartment');
            departments.forEach(dept => {
                const option = document.createElement('option');
                option.value = dept;
                option.textContent = dept;
                deptSelect.appendChild(option);
            });
        } catch (error) {
            console.error('åŠ è½½éƒ¨é—¨åˆ—è¡¨å¤±è´¥:', error);
        }
    }

    // åŠ è½½å­¦å‘˜åˆ—è¡¨
    // æ›´æ–°é¡µé¢æ—¥æœŸèŒƒå›´æ˜¾ç¤º
    function updatePageDateRange() {
        const startDate = document.getElementById('filterStartDate')?.value;
        const endDate = document.getElementById('filterEndDate')?.value;
        const dateRangeEl = document.getElementById('pageDateRange');

        if (!dateRangeEl) return;

        if (startDate || endDate) {
            const start = startDate || 'èµ·å§‹';
            const end = endDate || 'å½“å‰';
            dateRangeEl.textContent = `${start} è‡³ ${end}`;
            dateRangeEl.style.display = 'inline-block';
        } else {
            dateRangeEl.textContent = 'å½“å‰æœˆ';
            dateRangeEl.style.display = 'inline-block';
        }

        // åŒæ—¶æ›´æ–°å…³é”®äººå‘˜å›¾ä¾‹
        updateKeyPersonnelLegend(startDate, endDate);
    }

    // æ›´æ–°å…³é”®äººå‘˜å›¾ä¾‹è¯´æ˜ï¼ˆä½¿ç”¨åŠ¨æ€é…ç½®ï¼‰
    function updateKeyPersonnelLegend(startDate, endDate) {
        const legendEl = document.getElementById('keyPersonnelLegend');
        if (!legendEl) return;

        const threshold = keyPersonnelConfig.comprehensive_threshold;
        const violationThreshold = keyPersonnelConfig.monthly_violation_threshold;

        let legendText = `å…³é”®äººå‘˜ï¼ˆç»¼åˆåˆ†<${threshold} æˆ– æœˆå‡è¿è§„â‰¥${violationThreshold}æ¬¡ï¼‰`;
        legendEl.textContent = legendText;
    }

    async function loadStudents() {
        try {
            console.log('å¼€å§‹åŠ è½½äººå‘˜åˆ—è¡¨...');

            // æ„å»ºæŸ¥è¯¢å‚æ•°
            const params = new URLSearchParams();
            const startDate = document.getElementById('filterStartDate')?.value;
            const endDate = document.getElementById('filterEndDate')?.value;
            const department = document.getElementById('filterDepartment')?.value;
            const position = document.getElementById('filterPosition')?.value;

            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);
            if (department) params.append('department', department);
            if (position) params.append('position', position);

            // æ›´æ–°é¡µé¢æ—¥æœŸèŒƒå›´æ˜¾ç¤º
            updatePageDateRange();

            const url = `/personnel/api/students-list${params.toString() ? '?' + params.toString() : ''}`;
            const response = await fetch(url);
            console.log('APIå“åº”çŠ¶æ€:', response.status);

            if (!response.ok) {
                throw new Error('APIè¯·æ±‚å¤±è´¥: ' + response.status);
            }

            const data = await response.json();
            allStudents = data;
            students = data;
            console.log('è·å–åˆ°äººå‘˜æ•°æ®:', students.length, 'äºº');

            renderStudentList();

            // è‡ªåŠ¨é€‰æ‹©ç¬¬ä¸€ä¸ªå­¦å‘˜
            if (students.length > 0) {
                selectStudent(students[0].emp_no);
            }
        } catch (error) {
            console.error('åŠ è½½äººå‘˜åˆ—è¡¨å¤±è´¥:', error);
            document.getElementById('studentList').innerHTML =
                '<div class="no-data">åŠ è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</div>';
        }
    }

    // åº”ç”¨ç­›é€‰
    function applyFilters() {
        loadStudents();
    }

    // é‡ç½®ç­›é€‰
    function resetFilters() {
        document.getElementById('filterStartDate').value = '';
        document.getElementById('filterEndDate').value = '';
        document.getElementById('filterDepartment').value = '';
        document.getElementById('filterPosition').value = '';
        loadStudents();
    }

    // æ¸²æŸ“å­¦å‘˜åˆ—è¡¨
    function renderStudentList() {
        const listEl = document.getElementById('studentList');

        if (students.length === 0) {
            listEl.innerHTML = '<div class="no-data">æš‚æ— äººå‘˜æ•°æ®</div>';
            return;
        }

        listEl.innerHTML = students.map(s => `
            <div class="student-item ${s.is_key_personnel ? 'key-personnel' : ''}" onclick="selectStudent('${s.emp_no}')" id="student-${s.emp_no}">
                <div class="student-name">${s.name} (${s.emp_no})</div>
                <div class="student-meta">
                    <span>${s.department_name || 'æœªåˆ†é…éƒ¨é—¨'}</span>
                    <span class="student-score">ç»¼åˆ: ${s.comprehensive_score} åˆ†</span>
                </div>
            </div>
        `).join('');
    }

    // é€‰æ‹©å­¦å‘˜
    async function selectStudent(empNo) {
        selectedStudent = empNo;

        // æ›´æ–°æ¿€æ´»çŠ¶æ€
        document.querySelectorAll('.student-item').forEach(el => {
            el.classList.remove('active');
        });
        document.getElementById(`student-${empNo}`)?.classList.add('active');

        // åŠ è½½ç»¼åˆèƒ½åŠ›ç”»åƒ
        await loadComprehensiveProfile(empNo);
    }

    // å…¨å±€å˜é‡ç”¨äºå¤„ç†ç«æ€æ¡ä»¶
    let currentLoadingEmpNo = null;

    // æ¸…ç©ºèƒ½åŠ›ç”»åƒUIï¼ˆé‡ç½®ä¸ºåŠ è½½/ç©ºçŠ¶æ€ï¼‰
    function resetProfileUI() {
        // é‡ç½®åˆ†æ•°å¡ç‰‡
        const cards = ['scoreComprehensive', 'scoreTraining', 'scoreSafety', 'scorePerformance', 'scoreLearning', 'scoreStability'];
        cards.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = '--';
        });

        // é‡ç½®çŠ¶æ€æ ‡ç­¾
        const badges = ['stabilityAlertBadge', 'safetyAlertBadge', 'trainingAlertBadge', 'performanceAlertBadge', 'learningAlertBadge'];
        badges.forEach(id => {
            const el = document.getElementById(id);
            if (el) {
                el.textContent = 'åŠ è½½ä¸­...';
                el.className = 'badge bg-secondary';
            }
        });

        // é‡ç½®è¯¦æƒ…æ•°æ®
        const dataFields = [
            'stabilityScoreValue', 'stabilityBaseDeduction', 'stabilityRedlineCount', 'stabilityCvCapped', 'stabilitySafetyCv',
            'safetyViolations', 'safetyDeduction', 'safetyAvgFreq', 'safetyScoreA', 'safetyScoreB', 'safetyInspector', 'safetyRectifier',
            'trainingRadarScore', 'trainingOriginalScore', 'trainingCoefficient', 'totalTrainings', 'trainingFailCount',
            'recentPerformance', 'performanceLabel', 'performanceMode', 'performanceRange', 'performanceCount',
            'learningScoreValue', 'learningTier', 'learningInertiaRate', 'learningConsecutive', 'learningBaseScore', 'learningMonths'
        ];
        dataFields.forEach(id => {
            const el = document.getElementById(id);
            if (el) el.textContent = '--';
        });

        // æ¸…é™¤å›¾è¡¨
        if (comprehensiveRadarChart) {
            comprehensiveRadarChart.destroy();
            comprehensiveRadarChart = null;
        }
    }

    // åŠ è½½ä¸ªäººç»¼åˆèƒ½åŠ›ç”»åƒï¼ˆäººå‘˜+åŸ¹è®­+å®‰å…¨+ç»©æ•ˆï¼‰
    async function loadComprehensiveProfile(empNo) {
        // æ ‡è®°å½“å‰è¯·æ±‚ï¼Œé˜²æ­¢ç«æ€æ¡ä»¶
        currentLoadingEmpNo = empNo;

        // å…ˆé‡ç½®UIï¼Œé¿å…æ®‹ç•™ä¸Šä¸€ä¸ªäººçš„æ•°æ®
        resetProfileUI();

        try {
            // æ„å»ºæŸ¥è¯¢å‚æ•°ï¼ˆåŒ…å«æ—¥æœŸç­›é€‰ï¼‰
            const params = new URLSearchParams();
            const startDate = document.getElementById('filterStartDate')?.value;
            const endDate = document.getElementById('filterEndDate')?.value;

            if (startDate) params.append('start_date', startDate);
            if (endDate) params.append('end_date', endDate);

            const url = `/personnel/api/comprehensive-profile/${empNo}${params.toString() ? '?' + params.toString() : ''}`;
            const response = await fetch(url);

            // æ£€æŸ¥æ˜¯å¦åœ¨ç­‰å¾…å½“å‰è¯·æ±‚ï¼ˆç«æ€æ¡ä»¶å¤„ç†ï¼‰
            if (currentLoadingEmpNo !== empNo) {
                console.log(`å¿½ç•¥è¿‡æœŸçš„è¯·æ±‚ç»“æœ: ${empNo} (å½“å‰: ${currentLoadingEmpNo})`);
                return;
            }

            if (!response.ok) {
                throw new Error('APIè¯·æ±‚å¤±è´¥');
            }

            const data = await response.json();
            console.log('ç»¼åˆèƒ½åŠ›æ•°æ®:', data);

            // å®‰å…¨æ•°å€¼æ ¼å¼åŒ–è¾…åŠ©å‡½æ•°
            const formatNum = (val, digits = 1) => {
                return (val !== undefined && val !== null && !isNaN(val)) ? val.toFixed(digits) : '--';
            };

            // æ›´æ–°åˆ†æ•°å¡ç‰‡
            document.getElementById('scoreComprehensive').textContent = formatNum(data.scores?.comprehensive);
            document.getElementById('scoreTraining').textContent = formatNum(data.scores?.training);
            document.getElementById('scoreSafety').textContent = formatNum(data.scores?.safety);
            document.getElementById('scorePerformance').textContent = formatNum(data.scores?.performance);
            document.getElementById('scoreLearning').textContent = formatNum(data.scores?.learning);
            document.getElementById('scoreStability').textContent = formatNum(data.scores?.stability);

            // æ›´æ–°ç¨³å®šåº¦ä¿¡æ¯
            const stabilityDetails = data.stability_details || {};
            document.getElementById('stabilityScoreValue').textContent = formatNum(data.scores?.stability);
            document.getElementById('stabilityBaseDeduction').textContent = formatNum(stabilityDetails.base_deduction);
            document.getElementById('stabilityRedlineCount').textContent = stabilityDetails.redline_count ?? '--';
            document.getElementById('stabilityCvCapped').textContent = stabilityDetails.cv_capped ? 'æ˜¯' : 'å¦';
            document.getElementById('stabilitySafetyCv').textContent = formatNum(stabilityDetails.safety_cv, 3);

            // æ›´æ–°ç¨³å®šåº¦è­¦ç¤ºæ ‡ç­¾
            const stabilityBadge = document.getElementById('stabilityAlertBadge');
            if (stabilityBadge) {
                stabilityBadge.textContent = stabilityDetails.alert_tag || 'âœ… ç¨³å®š';
                stabilityBadge.className = 'badge'; // é‡ç½®ç±»å

                const sColor = stabilityDetails.status_color;
                if (sColor === 'GREEN') stabilityBadge.classList.add('bg-success');
                else if (sColor === 'YELLOW' || sColor === 'ORANGE') stabilityBadge.classList.add('bg-warning', 'text-dark');
                else if (sColor === 'RED') stabilityBadge.classList.add('bg-danger');
                else if (sColor === 'BLUE') stabilityBadge.classList.add('bg-primary');
                else stabilityBadge.classList.add('bg-secondary');
            }

            // æ›´æ–°å®‰å…¨ç»Ÿè®¡
            const safetyDetails = data.safety_details || {};
            document.getElementById('safetyViolations').textContent = safetyDetails.violations ?? '--';
            document.getElementById('safetyDeduction').textContent = formatNum(safetyDetails.total_deduction);
            document.getElementById('safetyAvgFreq').textContent = safetyDetails.avg_freq ?? '--';
            document.getElementById('safetyScoreA').textContent = safetyDetails.score_a ?? '--';
            document.getElementById('safetyScoreB').textContent = safetyDetails.score_b ?? '--';
            document.getElementById('safetyInspector').textContent = safetyDetails.as_inspector ?? '--';
            document.getElementById('safetyRectifier').textContent = safetyDetails.as_rectifier ?? '--';

            // æ›´æ–°å®‰å…¨è­¦ç¤ºæ ‡ç­¾
            const alertBadge = document.getElementById('safetyAlertBadge');
            if (alertBadge) {
                alertBadge.textContent = safetyDetails.alert_tag || 'æš‚æ— æ•°æ®';
                alertBadge.className = 'badge';

                if (safetyDetails.status_color === 'GREEN') alertBadge.classList.add('bg-success');
                else if (safetyDetails.status_color === 'ORANGE') alertBadge.classList.add('bg-warning');
                else if (safetyDetails.status_color === 'RED') alertBadge.classList.add('bg-danger');
                else alertBadge.classList.add('bg-secondary');
            }

            // æ›´æ–°åŸ¹è®­ç»Ÿè®¡
            const trainingDetails = data.training_details || {};
            document.getElementById('trainingRadarScore').textContent = formatNum(trainingDetails.radar_score);
            document.getElementById('trainingOriginalScore').textContent = formatNum(trainingDetails.original_score);
            document.getElementById('trainingCoefficient').textContent = formatNum(trainingDetails.penalty_coefficient, 2);
            document.getElementById('totalTrainings').textContent = trainingDetails.total_ops ?? 0;
            document.getElementById('trainingFailCount').textContent = trainingDetails.fail_count ?? 0;

            // æ›´æ–°åŸ¹è®­èƒ½åŠ›è­¦ç¤ºæ ‡ç­¾
            const trainingAlertBadge = document.getElementById('trainingAlertBadge');
            if (trainingAlertBadge) {
                trainingAlertBadge.textContent = trainingDetails.alert_tag || 'æš‚æ— æ•°æ®';
                trainingAlertBadge.className = 'badge';

                const tColor = trainingDetails.status_color;
                if (tColor === 'GREEN') trainingAlertBadge.classList.add('bg-success');
                else if (tColor === 'YELLOW') trainingAlertBadge.classList.add('bg-warning');
                else if (tColor === 'ORANGE') trainingAlertBadge.classList.add('bg-warning', 'text-dark');
                else if (tColor === 'RED') trainingAlertBadge.classList.add('bg-danger');
                else if (tColor === 'PURPLE') trainingAlertBadge.classList.add('bg-secondary');
                else trainingAlertBadge.classList.add('bg-secondary');
            }

            // æ›´æ–°ç»©æ•ˆç»Ÿè®¡
            const perfDetails = data.performance_details || {};
            document.getElementById('recentPerformance').textContent = formatNum(perfDetails.recent_avg);
            document.getElementById('performanceLabel').textContent = perfDetails.display_label || '--';
            document.getElementById('performanceMode').textContent = perfDetails.mode === 'MONTHLY' ? 'æœˆåº¦å¿«ç…§' : 'å‘¨æœŸåŠ æƒ';
            document.getElementById('performanceRange').textContent = perfDetails.range || '--';
            document.getElementById('performanceCount').textContent = perfDetails.count ?? 0;

            // æ›´æ–°ç»©æ•ˆè­¦ç¤ºæ ‡ç­¾
            const perfAlertBadge = document.getElementById('performanceAlertBadge');
            if (perfAlertBadge) {
                perfAlertBadge.textContent = perfDetails.alert_tag || 'æš‚æ— æ•°æ®';
                perfAlertBadge.className = 'badge';

                if (perfDetails.status_color === 'GREEN') perfAlertBadge.classList.add('bg-success');
                else if (perfDetails.status_color === 'ORANGE') perfAlertBadge.classList.add('bg-warning');
                else if (perfDetails.status_color === 'RED') perfAlertBadge.classList.add('bg-danger');
                else perfAlertBadge.classList.add('bg-secondary');
            }

            // æ›´æ–°å®‰å…¨è¶‹åŠ¿å¡ç‰‡ (V5.0 é£é™©æƒ¯æ€§ç‰ˆ)
            const learningDetails = data.learning_details;
            if (learningDetails) {
                document.getElementById('learningScoreValue').textContent = formatNum(data.scores?.learning);

                // é£é™©ç­‰çº§æ˜ å°„ (Dashboard Mapping)
                const riskMap = {
                    'SAFE': 'âœ… å®‰å…¨',
                    'WATCH_LIST': 'âš ï¸ é‡ç‚¹å…³æ³¨',
                    'HIGH_RISK': 'ğŸ”´ é«˜å±',
                    'PRE_ACCIDENT': 'â›” äº‹æ•…å‰å…†',
                    'UNKNOWN': 'â“ æœªçŸ¥'
                };
                const riskLevel = learningDetails.risk_level || 'UNKNOWN';
                const displayTier = riskMap[riskLevel] || riskLevel;
                document.getElementById('learningTier').textContent = displayTier;

                // æƒ¯æ€§æ‰£å‡ç‡ (æ ¸å¿ƒæ–°å­—æ®µ)
                const inertiaRate = learningDetails.inertia_penalty_rate || 0;
                const inertiaEl = document.getElementById('learningInertiaRate');
                if (inertiaEl) {
                    if (inertiaRate > 0) {
                        const pct = (inertiaRate * 100).toFixed(0);
                        inertiaEl.innerHTML = `<span class="text-danger fw-bold">-${pct}%</span>`;
                    } else {
                        inertiaEl.innerHTML = `<span class="text-success">æ— </span>`;
                    }
                }

                // è¿ç»­é«˜å±æœˆæ•°
                const consec = learningDetails.max_consecutive_danger || 0;
                const consecEl = document.getElementById('learningConsecutive');
                if (consecEl) {
                    if (consec >= 2) {
                        consecEl.innerHTML = `<span class="text-danger fw-bold">${consec} ä¸ªæœˆ</span>`;
                    } else if (consec === 1) {
                        consecEl.innerHTML = `<span class="text-warning">${consec} ä¸ªæœˆ</span>`;
                    } else {
                        consecEl.innerHTML = `<span class="text-success">æ— </span>`;
                    }
                }

                // åŸºç¡€å¾—åˆ†ï¼ˆæƒ¯æ€§æ‰£å‡å‰ï¼‰
                const baseScore = learningDetails.base_score || 0;
                const baseScoreEl = document.getElementById('learningBaseScore');
                if (baseScoreEl) {
                    baseScoreEl.textContent = formatNum(baseScore);
                }

                document.getElementById('learningMonths').textContent = learningDetails.months ?? '--';

                // æ›´æ–°è­¦ç¤ºæ ‡ç­¾
                const learningBadge = document.getElementById('learningAlertBadge');
                if (learningBadge) {
                    learningBadge.textContent = learningDetails.alert_tag || 'âœ… ç¨³å®š';
                    learningBadge.className = 'badge';

                    const riskL = learningDetails.risk_level;
                    if (riskL === 'SAFE') learningBadge.classList.add('bg-success');
                    else if (riskL === 'WATCH_LIST') learningBadge.classList.add('bg-warning', 'text-dark');
                    else if (riskL === 'HIGH_RISK') learningBadge.classList.add('bg-danger');
                    else if (riskL === 'PRE_ACCIDENT') learningBadge.classList.add('bg-dark');
                    else learningBadge.classList.add('bg-info');
                }
            }

            // æ¸²æŸ“äº”ç»´é›·è¾¾å›¾
            if (data.scores && data.training_details) {
                renderComprehensiveRadar(
                    data.scores,
                    data.training_details.status_color,
                    data.safety_details.status_color,
                    data.performance_details.status_color
                );
            }
        } catch (error) {
            console.error('åŠ è½½ç»¼åˆç”»åƒå¤±è´¥:', error);
            // è¿™é‡Œå¯ä»¥æ·»åŠ ä¸€ä¸ªé”™è¯¯æç¤ºåˆ°UI
        }
    }

    // æ¸²æŸ“äº”ç»´èƒ½åŠ›é›·è¾¾å›¾
    function renderComprehensiveRadar(scores, trainingStatusColor, safetyStatusColor, performanceStatusColor) {
        const canvas = document.getElementById('comprehensiveRadar');

        if (comprehensiveRadarChart) {
            comprehensiveRadarChart.destroy();
        }

        // ä¿å­˜è­¦ç¤ºæ ‡ç­¾ï¼Œç”¨äºtooltipæ˜¾ç¤º
        const trainingAlertTag = document.getElementById('trainingAlertBadge')?.textContent || 'âœ… èƒ½åŠ›è¾¾æ ‡';
        const safetyAlertTag = document.getElementById('safetyAlertBadge')?.textContent || 'âœ… å®‰å…¨';
        const performanceAlertTag = document.getElementById('performanceAlertBadge')?.textContent || 'âœ… è¾¾æ ‡';

        // æ ¹æ®åŸ¹è®­èƒ½åŠ›çŠ¶æ€ç¡®å®šåŸ¹è®­èƒ½åŠ›åœ†ç‚¹çš„é¢œè‰²
        let trainingPointColor = 'rgba(40, 167, 69, 1)';  // é»˜è®¤ç»¿è‰²
        if (trainingStatusColor === 'RED') {
            trainingPointColor = 'rgba(220, 53, 69, 1)';  // çº¢è‰²
        } else if (trainingStatusColor === 'ORANGE') {
            trainingPointColor = 'rgba(255, 193, 7, 1)';  // æ©™è‰²
        } else if (trainingStatusColor === 'YELLOW') {
            trainingPointColor = 'rgba(255, 235, 59, 1)';  // é»„è‰²
        } else if (trainingStatusColor === 'PURPLE') {
            trainingPointColor = 'rgba(156, 39, 176, 1)';  // ç´«è‰²
        }

        // æ ¹æ®å®‰å…¨çŠ¶æ€ç¡®å®šå®‰å…¨æ„è¯†åœ†ç‚¹çš„é¢œè‰²
        let safetyPointColor = 'rgba(40, 167, 69, 1)';  // é»˜è®¤ç»¿è‰²
        if (safetyStatusColor === 'RED') {
            safetyPointColor = 'rgba(220, 53, 69, 1)';  // çº¢è‰²
        } else if (safetyStatusColor === 'ORANGE') {
            safetyPointColor = 'rgba(255, 193, 7, 1)';  // æ©™è‰²
        }

        // æ ¹æ®ç»©æ•ˆçŠ¶æ€ç¡®å®šå·¥ä½œç»©æ•ˆåœ†ç‚¹çš„é¢œè‰²
        let performancePointColor = 'rgba(40, 167, 69, 1)';  // é»˜è®¤ç»¿è‰²
        if (performanceStatusColor === 'RED') {
            performancePointColor = 'rgba(220, 53, 69, 1)';  // çº¢è‰²
        } else if (performanceStatusColor === 'ORANGE') {
            performancePointColor = 'rgba(255, 193, 7, 1)';  // æ©™è‰²
        }

        // é›·è¾¾å›¾ä¿æŒé»˜è®¤è“è‰²ï¼Œä½†åŸ¹è®­èƒ½åŠ›ã€å®‰å…¨æ„è¯†å’Œå·¥ä½œç»©æ•ˆåœ†ç‚¹é¢œè‰²å•ç‹¬è®¾ç½®
        const defaultBlue = 'rgba(54, 162, 235, 1)';
        const radarData = {
            labels: ['åŸ¹è®­èƒ½åŠ›', 'å®‰å…¨æ„è¯†', 'å·¥ä½œç»©æ•ˆ', 'å®‰å…¨è¶‹åŠ¿', 'ç¨³å®šæ€§'],
            datasets: [{
                label: 'ä¸ªäººèƒ½åŠ›è¯„åˆ†',
                data: [
                    scores.training,
                    scores.safety,
                    scores.performance,
                    scores.learning,
                    scores.stability
                ],
                backgroundColor: 'rgba(54, 162, 235, 0.3)',
                borderColor: 'rgba(54, 162, 235, 1)',
                borderWidth: 2,
                // ä¸ºæ¯ä¸ªç»´åº¦è®¾ç½®ä¸åŒçš„åœ†ç‚¹é¢œè‰²
                pointBackgroundColor: [
                    trainingPointColor,       // 0: åŸ¹è®­èƒ½åŠ›ï¼ˆæ ¹æ®çŠ¶æ€å˜è‰²ï¼‰
                    safetyPointColor,         // 1: å®‰å…¨æ„è¯†ï¼ˆæ ¹æ®çŠ¶æ€å˜è‰²ï¼‰
                    performancePointColor,    // 2: å·¥ä½œç»©æ•ˆï¼ˆæ ¹æ®çŠ¶æ€å˜è‰²ï¼‰
                    defaultBlue,              // 3: å®‰å…¨è¶‹åŠ¿
                    defaultBlue               // 4: ç¨³å®šæ€§
                ],
                pointBorderColor: [
                    trainingPointColor,
                    safetyPointColor,
                    performancePointColor,
                    defaultBlue,
                    defaultBlue
                ],
                pointRadius: 5,
                pointHoverRadius: 7
            }]
        };

        comprehensiveRadarChart = new Chart(canvas, {
            type: 'radar',
            data: radarData,
            options: {
                responsive: true,
                maintainAspectRatio: false,
                scales: {
                    r: {
                        beginAtZero: true,
                        max: 100,
                        ticks: {
                            stepSize: 20,
                            font: { size: 12 }
                        },
                        pointLabels: {
                            font: { size: 14, weight: 'bold' }
                        },
                        grid: {
                            color: 'rgba(0, 0, 0, 0.1)'
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: { font: { size: 14 } }
                    },
                    tooltip: {
                        // è‡ªå®šä¹‰tooltipèƒŒæ™¯é¢œè‰²
                        backgroundColor: function (context) {
                            if (context.tooltip.dataPoints && context.tooltip.dataPoints[0]) {
                                const dataIndex = context.tooltip.dataPoints[0].dataIndex;

                                // åŸ¹è®­èƒ½åŠ›ï¼ˆç´¢å¼•0ï¼‰
                                if (dataIndex === 0) {
                                    if (trainingStatusColor === 'RED') {
                                        return 'rgba(220, 53, 69, 0.9)';
                                    } else if (trainingStatusColor === 'ORANGE') {
                                        return 'rgba(255, 193, 7, 0.9)';
                                    } else if (trainingStatusColor === 'YELLOW') {
                                        return 'rgba(255, 235, 59, 0.9)';
                                    } else if (trainingStatusColor === 'PURPLE') {
                                        return 'rgba(156, 39, 176, 0.9)';
                                    } else {
                                        return 'rgba(40, 167, 69, 0.9)';
                                    }
                                }

                                // å®‰å…¨æ„è¯†ï¼ˆç´¢å¼•1ï¼‰
                                if (dataIndex === 1) {
                                    if (safetyStatusColor === 'RED') {
                                        return 'rgba(220, 53, 69, 0.9)';
                                    } else if (safetyStatusColor === 'ORANGE') {
                                        return 'rgba(255, 193, 7, 0.9)';
                                    } else {
                                        return 'rgba(40, 167, 69, 0.9)';
                                    }
                                }

                                // å·¥ä½œç»©æ•ˆï¼ˆç´¢å¼•2ï¼‰
                                if (dataIndex === 2) {
                                    if (performanceStatusColor === 'RED') {
                                        return 'rgba(220, 53, 69, 0.9)';
                                    } else if (performanceStatusColor === 'ORANGE') {
                                        return 'rgba(255, 193, 7, 0.9)';
                                    } else {
                                        return 'rgba(40, 167, 69, 0.9)';
                                    }
                                }
                            }
                            // å…¶ä»–ç»´åº¦ä½¿ç”¨é»˜è®¤é»‘è‰²èƒŒæ™¯
                            return 'rgba(0, 0, 0, 0.8)';
                        },
                        titleColor: 'white',
                        bodyColor: 'white',
                        borderWidth: 1,
                        borderColor: 'rgba(255, 255, 255, 0.3)',
                        callbacks: {
                            label: function (context) {
                                // åŸ¹è®­èƒ½åŠ›ç»´åº¦ï¼ˆç´¢å¼•0ï¼‰
                                if (context.dataIndex === 0) {
                                    return [
                                        `${context.label}: ${context.parsed.r.toFixed(1)} åˆ†`,
                                        '',
                                        trainingAlertTag
                                    ];
                                }
                                // å®‰å…¨æ„è¯†ç»´åº¦ï¼ˆç´¢å¼•1ï¼‰
                                if (context.dataIndex === 1) {
                                    return [
                                        `${context.label}: ${context.parsed.r.toFixed(1)} åˆ†`,
                                        '',
                                        safetyAlertTag
                                    ];
                                }
                                // å·¥ä½œç»©æ•ˆç»´åº¦ï¼ˆç´¢å¼•2ï¼‰
                                if (context.dataIndex === 2) {
                                    return [
                                        `${context.label}: ${context.parsed.r.toFixed(1)} åˆ†`,
                                        '',
                                        performanceAlertTag
                                    ];
                                }
                                return `${context.label}: ${context.parsed.r.toFixed(1)} åˆ†`;
                            }
                        }
                    }
                }
            }
        });
    }


    // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
    // åŠ¨æ€è®¡ç®—çœŸå®è§†å£é«˜åº¦(è§£å†³æ‰‹æœºæµè§ˆå™¨åœ°å€æ é—®é¢˜)
    function setRealViewportHeight() {
        const vh = window.innerHeight * 0.01;
        document.documentElement.style.setProperty('--vh', `${vh}px`);
    }

    // é¡µé¢åŠ è½½å’Œçª—å£å¤§å°å˜åŒ–æ—¶æ›´æ–°
    setRealViewportHeight();
    window.addEventListener('resize', setRealViewportHeight);
    window.addEventListener('orientationchange', setRealViewportHeight);

    document.addEventListener('DOMContentLoaded', function () {
        console.log('é¡µé¢åŠ è½½å®Œæˆï¼Œå¼€å§‹åˆå§‹åŒ–...');

        // è°ƒè¯•:æ£€æŸ¥äººå‘˜åˆ—è¡¨å®¹å™¨é«˜åº¦
        setTimeout(() => {
            const panel = document.getElementById('studentListPanel');
            const list = document.getElementById('studentList');
            if (panel && list) {
                console.log('=== å¸ƒå±€è°ƒè¯•ä¿¡æ¯ ===');
                console.log('ä¾§è¾¹æ é¢æ¿é«˜åº¦:', panel.offsetHeight, 'px');
                console.log('äººå‘˜åˆ—è¡¨é«˜åº¦:', list.offsetHeight, 'px');
                console.log('äººå‘˜åˆ—è¡¨computed style:', window.getComputedStyle(list).flex);
                console.log('ä¾§è¾¹æ display:', window.getComputedStyle(panel).display);
                console.log('ä¾§è¾¹æ flex-direction:', window.getComputedStyle(panel).flexDirection);
            }
        }, 1000);

        // åˆå§‹åŒ–æ—¥æœŸç­›é€‰å™¨ï¼ˆæœˆä»½æ¨¡å¼ï¼Œä¼šè‡ªåŠ¨æ£€æµ‹input type="month"ï¼‰
        const dateFilter = new DateFilterHelper({
            startDateId: 'filterStartDate',
            endDateId: 'filterEndDate',
            defaultRange: 'current_month',
            showQuickButtons: true,
            validateDates: true,
            updateCallback: updatePageDateRange
        });

        loadKeyPersonnelConfig();  // å…ˆåŠ è½½é…ç½®
        loadDepartments();
        loadStudents();
    });

    // ç§»åŠ¨ç«¯ä¾§è¾¹æ æ§åˆ¶å‡½æ•°
    function toggleSidebar() {
        const panel = document.getElementById('studentListPanel');
        const overlay = document.getElementById('sidebarOverlay');

        if (panel && overlay) {
            panel.classList.toggle('show');
            overlay.classList.toggle('show');

            // é˜²æ­¢èƒŒæ™¯æ»šåŠ¨
            if (panel.classList.contains('show')) {
                document.body.style.overflow = 'hidden';
            } else {
                document.body.style.overflow = '';
            }
        }
    }

    // é€‰æ‹©äººå‘˜åè‡ªåŠ¨å…³é—­ä¾§è¾¹æ (ç§»åŠ¨ç«¯)
    const originalSelectStudent = selectStudent;
    selectStudent = async function (empNo) {
        await originalSelectStudent(empNo);

        // å¦‚æœæ˜¯ç§»åŠ¨ç«¯,é€‰æ‹©åè‡ªåŠ¨å…³é—­ä¾§è¾¹æ 
        if (window.innerWidth <= 768) {
            toggleSidebar();
        }
    };
</script>
{% endblock %}