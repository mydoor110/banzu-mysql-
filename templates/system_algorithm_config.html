{% extends "base.html" %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <h2>算法参数配置</h2>
            <p class="text-muted">配置人物画像算法的惩罚力度参数（仅系统管理员可配置）</p>
            <hr>
        </div>
    </div>

    <!-- 当前配置信息 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-body">
                    <h5 class="card-title">当前配置</h5>
                    <div id="current-config-info">
                        <p>加载中...</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 快速配置：预设方案 -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0">快速配置（预设方案）</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted mb-3">选择预设的惩罚力度方案，快速应用到系统</p>

                    <div class="row g-3" id="preset-options">
                        <!-- 预设方案选项将通过JavaScript动态加载 -->
                    </div>

                    <hr class="my-4">

                    <div class="mb-3">
                        <label for="preset-reason" class="form-label">变更原因：<span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="preset-reason" placeholder="请输入变更原因（必填）" required>
                    </div>

                    <button type="button" class="btn btn-primary" id="apply-preset-btn">
                        <i class="bi bi-check-circle"></i> 应用选中的预设方案
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- 高级自定义（折叠面板） -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header" style="cursor: pointer;" data-bs-toggle="collapse"
                    data-bs-target="#advanced-config">
                    <h5 class="mb-0">
                        <i class="bi bi-sliders"></i> 高级自定义
                        <small class="text-muted">（点击展开）</small>
                    </h5>
                </div>
                <div id="advanced-config" class="collapse">
                    <div class="card-body">
                        <p class="text-muted mb-4">
                            <i class="bi bi-info-circle"></i> 高级用户可以自定义所有算法参数。修改后将标记为"自定义配置"。
                        </p>

                        <!-- 配置表单容器 -->
                        <div id="custom-config-form">

                            <!-- 1. 绩效算法参数卡片 -->
                            <div class="card mb-4 border-primary">
                                <div class="card-header bg-primary bg-opacity-10">
                                    <h6 class="mb-0 text-primary">
                                        <i class="bi bi-graph-up"></i> 📊 工作绩效算法参数
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <!-- 算法说明区域 -->
                                    <div class="alert alert-light border p-3 mb-4">
                                        <h6 class="text-primary fw-bold"><i class="bi bi-calculator"></i> 算法逻辑说明</h6>
                                        <div class="small text-muted">
                                            <p class="mb-2"><strong>核心公式：</strong> <code>绩效分 = 等级系数 × 基准分(95)</code></p>
                                            <p class="mb-2"><strong>熔断机制（污染规则）：</strong>
                                                为了防止个别差绩效影响整体评价的公正性，当D级或C级出现次数达到阈值时，该维度分数将被强制封顶。</p>
                                            <ul class="mb-0">
                                                <li><strong>等级系数：</strong> 决定了不同绩效等级的得分比例（例如A级1.1倍，D级0倍）。</li>
                                                <li><strong>熔断阈值：</strong>
                                                    比如设置"D级1次熔断"，意味着只要有1次D级，无论其他月份表现如何，绩效分都不会超过设定的上限。</li>
                                            </ul>
                                        </div>
                                    </div>
                                    <!-- 等级系数 -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">
                                            等级系数
                                            <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip"
                                                title="各绩效等级对应的系数值，数值越小惩罚越严厉"></i>
                                        </label>
                                        <div class="row g-3">
                                            <div class="col-md-2">
                                                <label class="form-label small">D级</label>
                                                <input type="number" class="form-control" id="perf_coef_d" step="0.1"
                                                    min="0" max="2" data-path="performance.grade_coefficients.D">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label small">C级</label>
                                                <input type="number" class="form-control" id="perf_coef_c" step="0.1"
                                                    min="0" max="2" data-path="performance.grade_coefficients.C">
                                            </div>
                                            <div class="col-md-2">
                                                <label class="form-label small">B级</label>
                                                <input type="number" class="form-control" id="perf_coef_b" step="0.1"
                                                    min="0" max="2" data-path="performance.grade_coefficients.B">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small">B+级</label>
                                                <input type="number" class="form-control" id="perf_coef_bp" step="0.1"
                                                    min="0" max="2" data-path="performance.grade_coefficients.B+">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small">A级</label>
                                                <input type="number" class="form-control" id="perf_coef_a" step="0.1"
                                                    min="0" max="2" data-path="performance.grade_coefficients.A">
                                            </div>
                                        </div>
                                        <small class="text-muted">
                                            <i class="bi bi-lightbulb"></i> 推荐值：D=0.0, C=0.6, B=0.9, B+=1.0, A=1.1
                                        </small>
                                    </div>

                                    <hr>

                                    <!-- 熔断机制 -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">
                                            污染规则（熔断机制）
                                            <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip"
                                                title="防止差等级影响整体评价"></i>
                                        </label>
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <label class="form-label small">D级阈值（次）</label>
                                                <input type="number" class="form-control" id="perf_d_threshold" min="1"
                                                    max="10"
                                                    data-path="performance.contamination_rules.d_count_threshold">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small">D级上限（分）</label>
                                                <input type="number" class="form-control" id="perf_d_cap" step="0.1"
                                                    min="0" max="100"
                                                    data-path="performance.contamination_rules.d_cap_score">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small">C级阈值（次）</label>
                                                <input type="number" class="form-control" id="perf_c_threshold" min="1"
                                                    max="10"
                                                    data-path="performance.contamination_rules.c_count_threshold">
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small">C级上限（分）</label>
                                                <input type="number" class="form-control" id="perf_c_cap" step="0.1"
                                                    min="0" max="100"
                                                    data-path="performance.contamination_rules.c_cap_score">
                                            </div>
                                        </div>
                                        <small class="text-muted">
                                            <i class="bi bi-lightbulb"></i> D级≥1次触发熔断上限90分，C级≥2次触发熔断上限94.9分
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- 2. 安全算法参数卡片 -->
                            <div class="card mb-4 border-warning">
                                <div class="card-header bg-warning bg-opacity-10">
                                    <h6 class="mb-0 text-warning">
                                        <i class="bi bi-shield-check"></i> 🛡️ 安全意识算法参数
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <!-- 算法说明区域 -->
                                    <div class="alert alert-light border p-3 mb-4">
                                        <h6 class="text-warning fw-bold"><i class="bi bi-calculator"></i> 算法逻辑说明（双轨制）
                                        </h6>
                                        <div class="small text-muted">
                                            <p class="mb-2"><strong>核心公式：</strong> <code>最终得分 = Min(维度A得分, 维度B得分)</code>
                                                —— 取两者中的较低值，确保存木桶效应。</p>
                                            <div class="row">
                                                <div class="col-md-6 border-end">
                                                    <strong>维度A：行为习惯（关注频率）</strong><br>
                                                    <code>扣分 = 月均违规频次 × 阶梯倍数</code><br>
                                                    <em>例如：月均3次违规（落在2-5区间），倍数为5，则扣分=3×5=15分。</em>
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>维度B：后果严重性（关注程度）</strong><br>
                                                    <code>扣分 = Σ(单次违规分值 × 严重性系数)</code><br>
                                                    <em>例如：一次5分严重违规，系数为5.0，则单次扣分=5×5.0=25分。</em>
                                                </div>
                                            </div>
                                            <p class="mt-2 mb-0 text-danger"><strong>红线机制：</strong>
                                                若单次违规分值超过"重大违规红线"，该维度直接判为0分。</p>
                                        </div>
                                    </div>
                                    <!-- 行为频率轨道 -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">
                                            行为频率轨道
                                            <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip"
                                                title="违规次数越多，惩罚成倍增长"></i>
                                        </label>
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label small">频率阈值 (次数)</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="safety_freq_t1"
                                                        min="0" max="20"
                                                        data-path="safety.behavior_track.freq_thresholds.0"
                                                        placeholder="阈值1">
                                                    <input type="number" class="form-control" id="safety_freq_t2"
                                                        min="0" max="20"
                                                        data-path="safety.behavior_track.freq_thresholds.1"
                                                        placeholder="阈值2">
                                                    <input type="number" class="form-control" id="safety_freq_t3"
                                                        min="0" max="20"
                                                        data-path="safety.behavior_track.freq_thresholds.2"
                                                        placeholder="阈值3">
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small">惩罚倍数</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control" id="safety_freq_m1"
                                                        min="1" max="20"
                                                        data-path="safety.behavior_track.freq_multipliers.0"
                                                        placeholder="倍数1">
                                                    <input type="number" class="form-control" id="safety_freq_m2"
                                                        min="1" max="20"
                                                        data-path="safety.behavior_track.freq_multipliers.1"
                                                        placeholder="倍数2">
                                                    <input type="number" class="form-control" id="safety_freq_m3"
                                                        min="1" max="20"
                                                        data-path="safety.behavior_track.freq_multipliers.2"
                                                        placeholder="倍数3">
                                                </div>
                                            </div>
                                        </div>
                                        <small class="text-muted">
                                            <i class="bi bi-lightbulb"></i> 推荐值：阈值[2,5,6] 倍数[2,5,10]
                                        </small>
                                    </div>

                                    <hr>

                                    <!-- 后果严重性轨道 -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">
                                            后果严重性轨道（维度B）
                                            <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip"
                                                title="根据单次违规扣分值的严重程度，乘以不同的惩罚系数"></i>
                                        </label>
                                        <div class="alert alert-light border p-3">
                                            <!-- 轻微违规 -->
                                            <div class="row g-3 mb-3 align-items-center">
                                                <div class="col-md-3">
                                                    <label class="form-label small fw-bold">1. 轻微违规</label>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">分值 &lt;</span>
                                                        <input type="number" class="form-control" min="1" max="10"
                                                            data-path="safety.severity_track.score_ranges.0.max"
                                                            placeholder="3">
                                                    </div>
                                                </div>
                                                <div class="col-md-5">
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">惩罚系数</span>
                                                        <input type="number" class="form-control" step="0.1" min="0.1"
                                                            max="10"
                                                            data-path="safety.severity_track.score_ranges.0.multiplier"
                                                            placeholder="1.0">
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- 中等违规 -->
                                            <div class="row g-3 mb-3 align-items-center">
                                                <div class="col-md-3">
                                                    <label class="form-label small fw-bold">2. 中等违规</label>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">分值</span>
                                                        <input type="number" class="form-control" min="1" max="10"
                                                            data-path="safety.severity_track.score_ranges.1.min"
                                                            placeholder="3">
                                                        <span class="input-group-text">~</span>
                                                        <input type="number" class="form-control" min="1" max="10"
                                                            data-path="safety.severity_track.score_ranges.1.max"
                                                            placeholder="5">
                                                    </div>
                                                </div>
                                                <div class="col-md-5">
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">惩罚系数</span>
                                                        <input type="number" class="form-control" step="0.1" min="0.1"
                                                            max="10"
                                                            data-path="safety.severity_track.score_ranges.1.multiplier"
                                                            placeholder="2.5">
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- 严重违规 -->
                                            <div class="row g-3 mb-3 align-items-center">
                                                <div class="col-md-3">
                                                    <label class="form-label small fw-bold">3. 严重违规</label>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">分值 ≥</span>
                                                        <input type="number" class="form-control" min="1" max="10"
                                                            data-path="safety.severity_track.score_ranges.2.min"
                                                            placeholder="5">
                                                    </div>
                                                </div>
                                                <div class="col-md-5">
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">惩罚系数</span>
                                                        <input type="number" class="form-control" step="0.1" min="0.1"
                                                            max="10"
                                                            data-path="safety.severity_track.score_ranges.2.multiplier"
                                                            placeholder="5.0">
                                                    </div>
                                                </div>
                                            </div>

                                            <small class="text-muted">
                                                <i class="bi bi-lightbulb"></i> 推荐设置：轻微(&lt;3) 1.0倍，中等(3~5) 2.5倍，严重(≥5)
                                                5.0倍。请确保分值区间连续且不重叠。
                                            </small>
                                        </div>
                                    </div>

                                    <hr>

                                    <!-- 重大违规红线 -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">
                                            重大违规红线
                                            <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip"
                                                title="单次违规超过红线直接判定为安全意识差"></i>
                                        </label>
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <label class="form-label small">红线阈值（分）</label>
                                                <input type="number"
                                                    class="form-control form-control-lg text-danger fw-bold"
                                                    id="safety_critical" min="1" max="50"
                                                    data-path="safety.severity_track.critical_threshold">
                                            </div>
                                        </div>
                                        <small class="text-danger">
                                            <i class="bi bi-exclamation-triangle-fill"></i> 单次违规≥此值将直接判定为不合格
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- 3. 培训算法参数卡片 -->
                            <div class="card mb-4 border-success">
                                <div class="card-header bg-success bg-opacity-10">
                                    <h6 class="mb-0 text-success">
                                        <i class="bi bi-book"></i> 🎓 培训能力算法参数
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <!-- 算法说明区域 -->
                                    <div class="alert alert-light border p-3 mb-4">
                                        <h6 class="text-success fw-bold"><i class="bi bi-calculator"></i> 算法逻辑说明</h6>
                                        <div class="small text-muted">
                                            <p class="mb-2"><strong>核心公式：</strong> <code>最终分 = 基础分(平均成绩) × 惩罚系数</code>
                                            </p>
                                            <p class="mb-2"><strong>惩罚系数优先级（由高到低）：</strong></p>
                                            <ol class="mb-0">
                                                <li><strong>绝对失格：</strong> 失格次数 ≥ 阈值 → 直接使用"绝对失格系数"（最严厉）。</li>
                                                <li><strong>小样本惩罚：</strong> 培训总次数不足（如新员工） → 使用"小样本系数"降低置信度。</li>
                                                <li><strong>AFR年化失格率：</strong> 根据 <code>(失格数/天数)×365</code>
                                                    计算年化频率，按区间匹配系数。</li>
                                            </ol>
                                        </div>
                                    </div>
                                    <!-- 绝对失格阈值 -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">
                                            绝对失格阈值
                                            <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip"
                                                title="失格次数达标时，最终分数将被惩罚"></i>
                                        </label>
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label small">失格次数阈值</label>
                                                <input type="number" class="form-control" id="training_fail_count"
                                                    min="1" max="10"
                                                    data-path="training.penalty_rules.absolute_threshold.fail_count">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small">惩罚系数</label>
                                                <input type="number" class="form-control" id="training_fail_coef"
                                                    step="0.05" min="0" max="1"
                                                    data-path="training.penalty_rules.absolute_threshold.coefficient">
                                            </div>
                                        </div>
                                        <small class="text-muted">
                                            <i class="bi bi-lightbulb"></i> 推荐值：失格≥3次，惩罚系数0.5
                                        </small>
                                    </div>

                                    <hr>

                                    <!-- 小样本惩罚 -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">
                                            小样本惩罚
                                            <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip"
                                                title="培训次数不足时适度降低分数"></i>
                                        </label>
                                        <div class="row g-3">
                                            <div class="col-md-6">
                                                <label class="form-label small">样本量阈值</label>
                                                <input type="number" class="form-control" id="training_sample_size"
                                                    min="1" max="50"
                                                    data-path="training.penalty_rules.small_sample.sample_size">
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small">惩罚系数</label>
                                                <input type="number" class="form-control" id="training_sample_coef"
                                                    step="0.05" min="0" max="1"
                                                    data-path="training.penalty_rules.small_sample.coefficient">
                                            </div>
                                        </div>
                                        <small class="text-muted">
                                            <i class="bi bi-lightbulb"></i> 推荐值：样本量<10次，惩罚系数0.7 </small>
                                    </div>

                                    <hr>

                                    <!-- AFR年化失格率阈值 -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">
                                            AFR年化失格率阈值（可配置）
                                            <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip"
                                                title="此阈值决定失格频率分类：afr >= 高频阈值（高频），>= 偏高阈值（偏高），>= 偶发阈值（偶发）"></i>
                                        </label>
                                        <div class="alert alert-light border p-3">
                                            <!-- 高频失格配置 -->
                                            <div class="row g-3 mb-3 align-items-center">
                                                <div class="col-md-3">
                                                    <label class="form-label small fw-bold">1. 高频失格</label>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">AFR ≥</span>
                                                        <input type="number" class="form-control" step="0.1" min="0"
                                                            max="10"
                                                            data-path="training.penalty_rules.afr_thresholds.0.threshold"
                                                            placeholder="2.5">
                                                    </div>
                                                </div>
                                                <div class="col-md-5">
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">惩罚系数</span>
                                                        <input type="number" class="form-control" step="0.05" min="0"
                                                            max="1"
                                                            data-path="training.penalty_rules.afr_thresholds.0.coefficient"
                                                            placeholder="0.5">
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- 频率偏高配置 -->
                                            <div class="row g-3 mb-3 align-items-center">
                                                <div class="col-md-3">
                                                    <label class="form-label small fw-bold">2. 频率偏高</label>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">AFR ≥</span>
                                                        <input type="number" class="form-control" step="0.1" min="0"
                                                            max="10"
                                                            data-path="training.penalty_rules.afr_thresholds.1.threshold"
                                                            placeholder="1.5">
                                                    </div>
                                                </div>
                                                <div class="col-md-5">
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">惩罚系数</span>
                                                        <input type="number" class="form-control" step="0.05" min="0"
                                                            max="1"
                                                            data-path="training.penalty_rules.afr_thresholds.1.coefficient"
                                                            placeholder="0.7">
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- 偶发失格配置 -->
                                            <div class="row g-3 mb-3 align-items-center">
                                                <div class="col-md-3">
                                                    <label class="form-label small fw-bold">3. 偶发失格</label>
                                                </div>
                                                <div class="col-md-4">
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">AFR ≥</span>
                                                        <input type="number" class="form-control" step="0.1" min="0"
                                                            max="10"
                                                            data-path="training.penalty_rules.afr_thresholds.2.threshold"
                                                            placeholder="0.5">
                                                    </div>
                                                </div>
                                                <div class="col-md-5">
                                                    <div class="input-group input-group-sm">
                                                        <span class="input-group-text">惩罚系数</span>
                                                        <input type="number" class="form-control" step="0.05" min="0"
                                                            max="1"
                                                            data-path="training.penalty_rules.afr_thresholds.2.coefficient"
                                                            placeholder="0.9">
                                                    </div>
                                                </div>
                                            </div>

                                            <small class="text-muted d-block mt-2">
                                                <i class="bi bi-lightbulb"></i>
                                                推荐值：高频(AFR≥2.5)系数0.5，偏高(AFR≥1.5)系数0.7，偶发(AFR≥0.5)系数0.9
                                            </small>
                                            <small class="text-muted">
                                                <i class="bi bi-info-circle"></i> AFR = 失格次数 / (入职天数 / 365)
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>


                            <!-- 4.1 职业稳定度算法参数卡片（新版） -->
                            <div class="card mb-4 border-secondary">
                                <div class="card-header bg-secondary bg-opacity-10">
                                    <h6 class="mb-0 text-secondary">
                                        <i class="bi bi-shield-fill-check"></i> 🏆 职业稳定度算法参数（新版）
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <!-- 算法说明区域 -->
                                    <div class="alert alert-light border p-3 mb-4">
                                        <h6 class="text-secondary fw-bold"><i class="bi bi-calculator"></i> 算法逻辑说明（波动型）
                                        </h6>
                                        <div class="small text-muted">
                                            <p class="mb-2"><strong>设计理念：</strong>稳定度只衡量“安全表现波动”，不衡量风险水平。</p>
                                            <div class="row mb-2">
                                                <div class="col-md-6 border-end">
                                                    <strong>1. 时间窗口：</strong><br>
                                                    <em>近 window_months 个月滚动窗口，不足6个月则标记低置信度。</em>
                                                </div>
                                                <div class="col-md-6">
                                                    <strong>2. 波动指标：</strong><br>
                                                    <code>Mean |Δ| = 平均(|S_t - S_{t-1}|)</code><br>
                                                    <em>仅对“有效月份”序列计算。</em>
                                                </div>
                                            </div>
                                            <div class="mb-2">
                                                <strong>3. 分位映射：</strong><br>
                                                <code>p25 → 90，p75 → 60（线性插值）</code><br>
                                                <em>最终分值 clamp 至 [40, 100]。</em>
                                            </div>
                                            <div class="mb-0">
                                                <strong>4. 标签与提示：</strong><br>
                                                <span class="badge bg-success">稳定</span>
                                                <span class="badge bg-warning text-dark">波动偏大</span>
                                                <span class="badge bg-danger">波动较大</span>
                                                <div class="text-muted mt-1">可提示：安全波动异常 / 低水平（安全维度雷达分≤阈值） / 样本不足</div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">1) window_months（滚动窗口）</label>
                                        <select class="form-select form-select-sm" data-path="stability_new.window_months"
                                            data-value-type="number">
                                            <option value="6">6 个月｜更敏感（近期波动更重要）</option>
                                            <option value="9">9 个月｜平衡</option>
                                            <option value="12">12 个月｜更稳健（默认）</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">2) volatility_metric（波动指标）</label>
                                        <select class="form-select form-select-sm" data-path="stability_new.volatility_metric">
                                            <option value="mean_abs_delta">月度变化幅度均值（Mean |Δ|）</option>
                                            <option value="mad">MAD（月度安全分）</option>
                                            <option value="cv">CV（月度安全分）</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">3) score_map（分位映射档位）</label>
                                        <select class="form-select form-select-sm" id="stabilityScoreMapPreset">
                                            <option value="strict">严格：p20 → 90，p70 → 60</option>
                                            <option value="standard">标准：p25 → 90，p75 → 60</option>
                                            <option value="lenient">宽松：p30 → 90，p80 → 60</option>
                                            <option value="custom">自定义</option>
                                        </select>
                                        <input type="hidden" id="stabilityScoreMapLow"
                                            data-path="stability_new.score_map_low" data-value-type="number">
                                        <input type="hidden" id="stabilityScoreMapHigh"
                                            data-path="stability_new.score_map_high" data-value-type="number">
                                        <small class="text-muted" id="stabilityScoreMapHint">--</small>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">4) high_vol_threshold（高波动阈值）</label>
                                        <select class="form-select form-select-sm" data-path="stability_new.high_vol_threshold"
                                            data-value-type="number">
                                            <option value="0.0576">高敏（p70 ≈ 0.0576）</option>
                                            <option value="0.0667">标准（p75 ≈ 0.0667）</option>
                                            <option value="0.0774">中等（p80 ≈ 0.0774）</option>
                                            <option value="0.0855">宽松（p85 ≈ 0.0855）</option>
                                            <option value="0.1242">很宽松（p90 ≈ 0.1242）</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">5) k_multiplier（安全CV相对综合CV倍数）</label>
                                        <select class="form-select form-select-sm" data-path="stability_new.k_multiplier"
                                            data-value-type="number">
                                            <option value="1.1">1.1｜更敏感</option>
                                            <option value="1.2">1.2｜标准</option>
                                            <option value="1.3">1.3｜更严格</option>
                                        </select>
                                    </div>

                                    <div class="mb-3">
                                        <label class="form-label fw-bold">6) label_cutoffs（稳定度标签分段）</label>
                                        <select class="form-select form-select-sm" id="stabilityLabelPreset">
                                            <option value="strict">严格：≥85 / 55–85 / &lt;55</option>
                                            <option value="standard">标准：≥75 / 60–75 / &lt;60</option>
                                            <option value="lenient">宽松：≥70 / 55–70 / &lt;55</option>
                                            <option value="custom">自定义</option>
                                        </select>
                                        <input type="hidden" id="stabilityLabelStable"
                                            data-path="stability_new.label_cutoffs.stable" data-value-type="number">
                                        <input type="hidden" id="stabilityLabelMedium"
                                            data-path="stability_new.label_cutoffs.medium" data-value-type="number">
                                        <small class="text-muted" id="stabilityLabelHint">--</small>
                                    </div>

                                    <small class="text-muted d-block mt-2">
                                        <i class="bi bi-info-circle"></i> 滚动窗口：统计最近 N 个月的波动，月数越多越稳健。
                                    </small>
                                    <small class="text-muted d-block">
                                        <i class="bi bi-info-circle"></i> 分位映射：用“严格/标准/宽松”控制稳定度评分的分层力度。
                                    </small>
                                    <small class="text-muted d-block">
                                        <i class="bi bi-info-circle"></i> 波动指标：衡量“忽高忽低”的程度，分数越低波动越大。
                                    </small>
                                    <small class="text-muted d-block">
                                        <i class="bi bi-info-circle"></i> 高波动阈值：波动异常判定的敏感度。
                                    </small>
                                    <small class="text-muted d-block">
                                        <i class="bi bi-info-circle"></i> 倍数系数：只标记安全维度波动明显高于整体的人。
                                    </small>
                                </div>
                            </div>

                            <!-- 4.2 安全趋势算法参数卡片（新版） -->
                            <div class="card mb-4 border-info">
                                <div class="card-header bg-info bg-opacity-10">
                                    <h6 class="mb-0 text-info">
                                        <i class="bi bi-graph-up-arrow"></i> 📈 安全趋势算法参数（新版）
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <!-- 算法说明区域 -->
                                    <div class="alert alert-light border p-3 mb-4">
                                        <h6 class="text-info fw-bold"><i class="bi bi-calculator"></i> 算法逻辑说明（V5.0
                                            风险惯性模型 - 行为演化与事故预测）</h6>
                                        <div class="small text-muted">
                                            <p class="mb-2"><strong>核心理念：</strong>
                                                <code>风险惯性 (Risk Inertia)</code>。系统具备"记忆力"，能够识别<span class="text-danger fw-bold">长尾高风险群体</span>，防止短期数据"洗白"。
                                            </p>

                                            <div class="mb-2">
                                                <strong>1. 单月状态判定 (L<sub>month</sub>)：</strong><br>
                                                <em>水位线计算：</em><br>
                                                <code>关注线 = min(max(班组均值×倍率, 保底值, 历史基准), <span class="text-danger">绝对天花板</span>)</code><br>
                                                <code>熔断线 = max(班组均值×熔断倍率, 熔断保底值)</code><br>
                                                <em>区域判定：</em>
                                                <ul class="mb-1 ps-3">
                                                    <li><span class="text-success">✅ 安全区 (SAFE)：</span> 违规数 < 关注线 → 分数按安全区系数计算</li>
                                                    <li><span class="text-warning">⚠️ 危险区 (DANGER)：</span> 违规数 ≥ 关注线 → 分数按危险区系数计算</li>
                                                    <li><span class="text-danger">⛔ 熔断区 (CRITICAL)：</span> 违规数 ≥ 熔断线 → 分数=0 (一票否决)</li>
                                                </ul>
                                                <em>返回：{'score': 80, 'zone': 'DANGER', 'count': 5}</em>
                                            </div>

                                            <div class="mb-2">
                                                <strong>2. 风险惯性惩罚公式：</strong><br>
                                                扫描周期内 zone 序列，寻找 <strong>连续处于 DANGER/CRITICAL 的最大月数 (K<sub>max</sub>)</strong><br>
                                                <code>若 K<sub>max</sub> < 惯性启动月数: 惯性 = 0</code><br>
                                                <code class="text-danger fw-bold">若 K<sub>max</sub> ≥ 惯性启动月数: 惯性 = min((K<sub>max</sub> - 启动月数 + 1) × 步长, 最大惩罚)</code><br>
                                                <em class="text-info">例如：连续3个月危险 (启动=2, 步长=0.15) → (3-2+1)×0.15 = 30% 惩罚</em>
                                            </div>

                                            <div class="mb-2">
                                                <strong>3. 最终计算：</strong><br>
                                                <code class="text-primary fw-bold">最终得分 = 基础加权分 × (1 - 惯性扣减率)</code><br>
                                                <em class="text-danger">业务含义：一个连续 4 个月处于危险边缘的"老油条"，即使每月得分60分，经过惯性惩罚(-45%)后，最终只有33分（高危）。</em>
                                            </div>

                                            <div class="mb-0 border-top pt-2">
                                                <strong>4. 风险等级映射：</strong><br>
                                                <span class="badge bg-dark">⛔ 事故前兆</span> 惯性惩罚≥40% 或 曾触发熔断 |
                                                <span class="badge bg-danger">🔴 高危</span> 分数<60 |
                                                <span class="badge bg-warning text-dark">⚠️ 重点关注</span> 近期处于危险区 |
                                                <span class="badge bg-success">✅ 安全</span> 其他
                                            </div>
                                        </div>
                                    </div>

                                    <!-- A. 动态水位 (The Filter) -->
                                    <div class="mb-4">
                                        <label class="form-label fw-bold">
                                            A. 动态水位 (The Filter) - 防止群体漂移的核心红线
                                            <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip"
                                                title="关注线和熔断线的计算参数"></i>
                                        </label>
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <label class="form-label small text-danger fw-bold">绝对天花板 (Ceiling)</label>
                                                <input type="number" class="form-control border-danger" min="1" max="20"
                                                    data-path="learning_new.trend_ceiling_floor" placeholder="5">
                                                <small class="text-danger">⚠️ 核心红线：超过此值必入危险区</small>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small">关注线倍率</label>
                                                <input type="number" class="form-control" step="0.1" min="1" max="5"
                                                    data-path="learning_new.trend_warning_ratio" placeholder="1.5">
                                                <small class="text-muted">班组均值 × 此倍率</small>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small">关注线保底值</label>
                                                <input type="number" class="form-control" min="1" max="10"
                                                    data-path="learning_new.trend_warning_floor" placeholder="2">
                                                <small class="text-muted">最低关注线</small>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small">熔断线倍率</label>
                                                <input type="number" class="form-control" step="0.1" min="2" max="10"
                                                    data-path="learning_new.trend_critical_ratio" placeholder="3.0">
                                                <small class="text-danger">超过此线直接0分</small>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small">熔断线保底值</label>
                                                <input type="number" class="form-control" min="3" max="20"
                                                    data-path="learning_new.trend_critical_floor" placeholder="5">
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small">历史安全基准</label>
                                                <input type="number" class="form-control" min="1" max="10"
                                                    data-path="learning_new.historical_baseline" placeholder="3">
                                                <small class="text-muted">关注线兜底值</small>
                                            </div>
                                        </div>
                                        <small class="text-muted mt-2">
                                            <i class="bi bi-lightbulb"></i> 关注线 = min(max(班组均值×倍率, 保底值, 历史基准), <span class="text-danger">绝对天花板</span>)
                                        </small>
                                    </div>

                                    <hr>

                                    <!-- B. 阶梯趋势系数 (The Matrix) -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">
                                            B. 阶梯趋势系数 (The Matrix)
                                            <i class="bi bi-info-circle text-muted" data-bs-toggle="tooltip"
                                                title="安全区与危险区的评分因子"></i>
                                        </label>
                                        <div class="alert alert-info py-2 mb-2">
                                            <small><i class="bi bi-info-circle"></i> <strong>安全区系数：</strong> 奖励=1.2, 稳定=1.0, 波动=0.9 | <strong>危险区系数：</strong> 改善=0.8, 冷启动=0.6, 固化=0.4, 恶化=0.3</small>
                                        </div>
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <label class="form-label small text-success">安全区·奖励系数</label>
                                                <input type="number" class="form-control" step="0.1" min="1" max="2"
                                                    data-path="learning_new.factor_reward" placeholder="1.2">
                                                <small class="text-success">改善+20%</small>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small text-success">安全区·稳定系数</label>
                                                <input type="number" class="form-control" step="0.1" min="0.5" max="1.5"
                                                    data-path="learning_new.factor_stable" placeholder="1.0">
                                                <small class="text-success">保持原分</small>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small text-warning">危险区·改善系数</label>
                                                <input type="number" class="form-control" step="0.1" min="0" max="1"
                                                    data-path="learning_new.factor_mitigation" placeholder="0.8">
                                                <small class="text-warning">减轻惩罚但不奖励</small>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small text-warning">危险区·冷启动系数</label>
                                                <input type="number" class="form-control" step="0.1" min="0" max="1"
                                                    data-path="learning_new.factor_warning" placeholder="0.6">
                                                <small class="text-warning">无历史数据时</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small text-danger fw-bold">危险区·固化系数 (高位持平)</label>
                                                <input type="number" class="form-control border-danger" step="0.1" min="0" max="1"
                                                    data-path="learning_new.factor_solidification" placeholder="0.4">
                                                <small class="text-danger">⚠️ 风险固化严厉惩罚，推荐0.4</small>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small text-danger fw-bold">危险区·恶化系数 (高位上升)</label>
                                                <input type="number" class="form-control border-danger" step="0.1" min="0" max="1"
                                                    data-path="learning_new.factor_deterioration" placeholder="0.3">
                                                <small class="text-danger">⚠️ 恶化更严厉，推荐0.3</small>
                                            </div>
                                        </div>
                                    </div>

                                    <hr>

                                    <!-- C. 风险惯性 (The Risk Inertia) -->
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">
                                            C. 风险惯性 (The Risk Inertia) - V5.0 核心
                                            <i class="bi bi-shield-exclamation text-danger" data-bs-toggle="tooltip"
                                                title="识别长尾高风险群体，防止短期洗白"></i>
                                        </label>
                                        <div class="alert alert-danger py-2 mb-2">
                                            <small><i class="bi bi-exclamation-triangle"></i> <strong>风险惯性公式：</strong>
                                                若连续 <strong>K<sub>max</sub></strong> 个月处于危险区 (≥启动月数)，
                                                <code>惯性 = min((K<sub>max</sub> - 启动月数 + 1) × 步长, 最大惩罚)</code>
                                                <br><em class="text-info">例如：连续3个月 → (3-2+1)×0.15 = 30% 惩罚</em>
                                            </small>
                                        </div>
                                        <div class="row g-3">
                                            <div class="col-md-3">
                                                <label class="form-label small text-danger fw-bold">惯性启动阈值 (月)</label>
                                                <input type="number" class="form-control border-danger" min="1" max="6"
                                                    data-path="learning_new.inertia_start_months" placeholder="2">
                                                <small class="text-danger">连续N月危险区开始计算惯性</small>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small text-danger fw-bold">惯性累积步长</label>
                                                <input type="number" class="form-control border-danger" step="0.05"
                                                    min="0" max="0.5" data-path="learning_new.inertia_step"
                                                    placeholder="0.15">
                                                <small class="text-danger">每多1月增加15%惩罚</small>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small text-danger fw-bold">最大惯性惩罚</label>
                                                <input type="number" class="form-control border-danger" step="0.1"
                                                    min="0" max="1.0" data-path="learning_new.inertia_max_penalty"
                                                    placeholder="0.6">
                                                <small class="text-danger">封顶扣除60%</small>
                                            </div>
                                            <div class="col-md-3">
                                                <label class="form-label small">时间衰减率</label>
                                                <input type="number" class="form-control" step="0.05" min="0" max="1"
                                                    data-path="learning_new.time_decay_rate" placeholder="0.2">
                                                <small class="text-muted">近期月份权重更高</small>
                                            </div>
                                        </div>
                                        <div class="alert alert-info py-2 mt-3 mb-0">
                                            <small><i class="bi bi-lightbulb"></i> <strong>业务含义：</strong>
                                                一个连续4个月处于危险边缘的"老油条"，即使每月得分60分（及格），
                                                经过惯性惩罚(-45%)后，最终得分只有33分（高危）。
                                                这精准识别了"事故前兆群体"。
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 4.3 九宫格配置卡片 -->
                            <div class="card mb-4 border-dark">
                                <div class="card-header bg-dark bg-opacity-10">
                                    <h6 class="mb-0 text-dark">
                                        <i class="bi bi-grid-3x3"></i> 🎯 人才九宫格Y轴权重
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="alert alert-light border p-3">
                                        <p class="mb-2"><strong>设计说明：</strong>九宫格Y轴 = 稳定度×权重 + 安全趋势×权重</p>
                                        <p class="mb-0 text-muted small">X轴使用三维综合分（绩效+安全+培训），复用综合评分权重配置</p>
                                    </div>

                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label small">稳定度权重</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" step="0.1" min="0" max="1"
                                                    data-path="nine_grid.y_axis_weights.stability" placeholder="0.4">
                                                <span class="input-group-text">×100%</span>
                                            </div>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label small">安全趋势权重</label>
                                            <div class="input-group">
                                                <input type="number" class="form-control" step="0.1" min="0" max="1"
                                                    data-path="nine_grid.y_axis_weights.learning" placeholder="0.6">
                                                <span class="input-group-text">×100%</span>
                                            </div>
                                        </div>
                                    </div>
                                    <small class="text-muted mt-2">
                                        <i class="bi bi-lightbulb"></i> 推荐值：稳定度40% + 安全趋势60%（两项之和应为1.0）
                                    </small>
                                </div>
                            </div>

                            <!-- 5. 综合评分权重卡片 -->
                            <div class="card mb-4 border-info">
                                <div class="card-header bg-info bg-opacity-10">
                                    <h6 class="mb-0 text-info">
                                        <i class="bi bi-pie-chart"></i> ⚖️ 综合评分权重
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label class="form-label fw-bold">
                                            五维度权重配置
                                            <span class="badge bg-danger ms-2">总和必须=100%</span>
                                        </label>
                                        <div class="row g-3">
                                            <div class="col-md-4">
                                                <label class="form-label small">工作绩效</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control weight-input"
                                                        id="weight_performance" step="1" min="0" max="100"
                                                        data-path="comprehensive.score_weights.performance">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small">安全意识</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control weight-input"
                                                        id="weight_safety" step="1" min="0" max="100"
                                                        data-path="comprehensive.score_weights.safety">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                            <div class="col-md-4">
                                                <label class="form-label small">培训能力</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control weight-input"
                                                        id="weight_training" step="1" min="0" max="100"
                                                        data-path="comprehensive.score_weights.training">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small">职业稳定性</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control weight-input"
                                                        id="weight_stability" step="1" min="0" max="100"
                                                        data-path="comprehensive.score_weights.stability">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                            <div class="col-md-6">
                                                <label class="form-label small">学习能力</label>
                                                <div class="input-group">
                                                    <input type="number" class="form-control weight-input"
                                                        id="weight_learning" step="1" min="0" max="100"
                                                        data-path="comprehensive.score_weights.learning">
                                                    <span class="input-group-text">%</span>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="mt-2">
                                            <span class="text-muted">当前总和：</span>
                                            <span id="weight-sum" class="fw-bold">0%</span>
                                            <span id="weight-status" class="ms-2"></span>
                                        </div>
                                        <small class="text-muted">
                                            <i class="bi bi-lightbulb"></i> 推荐值：绩效35% 安全30% 培训20% 稳定10% 学习5%
                                        </small>
                                    </div>
                                </div>
                            </div>

                            <!-- 5. 关键人员判定卡片 -->
                            <div class="card mb-4 border-danger">
                                <div class="card-header bg-danger bg-opacity-10">
                                    <h6 class="mb-0 text-danger">
                                        <i class="bi bi-exclamation-triangle"></i> 🎯 关键人员判定标准
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">综合分数阈值</label>
                                            <input type="number" class="form-control" id="key_threshold" min="0"
                                                max="100" data-path="key_personnel.comprehensive_threshold">
                                            <small class="text-muted">低于此分数的人员被标记为关键关注对象</small>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label fw-bold">月度违规阈值</label>
                                            <input type="number" class="form-control" id="key_violation" min="0"
                                                max="20" data-path="key_personnel.monthly_violation_threshold">
                                            <small class="text-muted">月均违规超过此次数被标记为关键关注</small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- 保存按钮区域 -->
                            <div class="card bg-light">
                                <div class="card-body">
                                    <div class="mb-3">
                                        <label for="custom-reason" class="form-label fw-bold">
                                            变更原因：<span class="text-danger">*</span>
                                        </label>
                                        <input type="text" class="form-control" id="custom-reason"
                                            placeholder="请输入变更原因（必填）" required>
                                    </div>

                                    <div class="d-flex gap-2">
                                        <button type="button" class="btn btn-info btn-lg" id="effect-preview-btn-main">
                                            <i class="bi bi-eye-fill"></i> 效果预览
                                        </button>
                                        <button type="button" class="btn btn-success btn-lg"
                                            id="save-custom-config-btn">
                                            <i class="bi bi-save"></i> 保存自定义配置
                                        </button>
                                        <button type="button" class="btn btn-outline-secondary"
                                            id="reset-custom-config-btn">
                                            <i class="bi bi-arrow-counterclockwise"></i> 重置为当前配置
                                        </button>
                                    </div>
                                </div>
                            </div>

                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- 旧的参数说明面板（暂时保留用于参考，后续可删除） -->
    <div class="row mb-4 d-none">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h6>参数说明（旧版）</h6>
                </div>
                <div class="card-body">
                    <div class="accordion" id="paramHelp">
                        <!-- 绩效算法参数 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#perf-help">
                                    <strong>📊 工作绩效算法参数</strong>
                                </button>
                            </h2>
                            <div id="perf-help" class="accordion-collapse collapse" data-bs-parent="#paramHelp">
                                <div class="accordion-body" style="font-size: 0.9rem;">
                                    <p class="mb-2"><code>performance.grade_coefficients</code> - <strong>等级系数</strong>
                                    </p>
                                    <ul class="mb-3">
                                        <li>各绩效等级对应的系数值（D/C/B/B+/A）</li>
                                        <li>数值越小，惩罚越严厉（D=0.0表示零分）</li>
                                        <li>示例：D等级系数0.0表示D级直接记0分</li>
                                    </ul>

                                    <p class="mb-2"><code>performance.grade_ranges</code> - <strong>等级分数范围</strong></p>
                                    <ul class="mb-3">
                                        <li>min/max：各等级对应的最低和最高分数</li>
                                        <li>radar_override：D级特殊处理的雷达图显示分数</li>
                                        <li>示例：D等级范围0-79.9，雷达图固定显示50分</li>
                                    </ul>

                                    <p class="mb-2"><code>performance.contamination_rules</code> -
                                        <strong>污染规则（熔断机制）</strong>
                                    </p>
                                    <ul class="mb-3">
                                        <li>d_count_threshold：D级出现多少次触发熔断（默认1次）</li>
                                        <li>c_count_threshold：C级出现多少次触发熔断（默认2次）</li>
                                        <li>d_cap_score：触发D级熔断后的分数上限（严格90分）</li>
                                        <li>c_cap_score：触发C级熔断后的分数上限（严格94.9分）</li>
                                        <li>作用：防止差等级影响整体评价</li>
                                    </ul>

                                    <p class="mb-2"><code>performance.time_decay</code> - <strong>时间衰减机制</strong> <span
                                            class="badge bg-success">新增</span></p>
                                    <ul class="mb-0">
                                        <li>enabled：是否启用时间衰减（默认true）</li>
                                        <li>decay_months：衰减窗口月数（默认6个月）</li>
                                        <li>decay_rate：每月衰减率（默认0.9，即每月衰减10%）</li>
                                        <li>作用：跨月/年度计算中，D级/C级影响随时间减弱</li>
                                        <li>示例：6个月前的D级有效权重=0.9^6≈0.53，7个月前不计入</li>
                                        <li><span class="text-info">仅在跨月/年度计算中生效，月度快照不启用</span></li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- 安全算法参数 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#safety-help">
                                    <strong>🛡️ 安全意识算法参数</strong>
                                </button>
                            </h2>
                            <div id="safety-help" class="accordion-collapse collapse" data-bs-parent="#paramHelp">
                                <div class="accordion-body" style="font-size: 0.9rem;">
                                    <p class="mb-2"><code>safety.behavior_track</code> - <strong>行为频率轨道</strong></p>
                                    <ul class="mb-3">
                                        <li>freq_thresholds：违规次数阈值（2次、5次、6次）</li>
                                        <li>freq_multipliers：对应的惩罚倍数（2倍、5倍、10倍）</li>
                                        <li>作用：违规次数越多，惩罚成倍增长</li>
                                    </ul>

                                    <p class="mb-2"><code>safety.severity_track</code> - <strong>严重程度轨道</strong></p>
                                    <ul class="mb-3">
                                        <li>score_ranges：不同扣分范围的惩罚倍数</li>
                                        <li>示例：单次扣3分以下×1.0，3-5分×2.5，5分以上×5.0</li>
                                        <li>critical_threshold：重大违规红线（默认12分）</li>
                                        <li>超过红线直接判定为安全意识差</li>
                                    </ul>

                                    <p class="mb-2"><code>safety.thresholds</code> - <strong>评分阈值</strong></p>
                                    <ul class="mb-0">
                                        <li>fail_score：不合格分数线（低于60分）</li>
                                        <li>warning_score：警告分数线（低于90分）</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- 培训算法参数 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#training-help">
                                    <strong>🎓 培训能力算法参数</strong>
                                </button>
                            </h2>
                            <div id="training-help" class="accordion-collapse collapse" data-bs-parent="#paramHelp">
                                <div class="accordion-body" style="font-size: 0.9rem;">
                                    <p class="mb-2"><code>training.penalty_rules.absolute_threshold</code> -
                                        <strong>绝对失格阈值</strong>
                                    </p>
                                    <ul class="mb-3">
                                        <li>fail_count：失格次数阈值（默认3次）</li>
                                        <li>coefficient：惩罚系数（默认0.5，严格0.4）</li>
                                        <li>作用：失格次数达标时，最终分数×系数</li>
                                    </ul>

                                    <p class="mb-2"><code>training.penalty_rules.small_sample</code> -
                                        <strong>小样本惩罚</strong>
                                    </p>
                                    <ul class="mb-3">
                                        <li>sample_size：样本量阈值（默认10次）</li>
                                        <li>coefficient：样本不足时的惩罚系数（0.7）</li>
                                        <li>作用：培训次数少时适度降低分数</li>
                                    </ul>

                                    <p class="mb-2"><code>training.penalty_rules.afr_thresholds_new_employee</code> -
                                        <strong>新员工AFR阈值</strong> <span class="badge bg-success">新增</span>
                                    </p>
                                    <ul class="mb-3">
                                        <li>适用对象：取证年限<1年的新员工< /li>
                                        <li>AFR = (失格次数 / 统计天数) × 365</li>
                                        <li>不同频率区间对应不同系数和标签</li>
                                        <li>示例：AFR≥5.0为"高频失格"，系数0.55（更宽松）</li>
                                        <li><span class="text-info">新员工阈值更宽松，给予成长空间</span></li>
                                    </ul>

                                    <p class="mb-2"><code>training.penalty_rules.afr_thresholds_experienced</code> -
                                        <strong>老员工AFR阈值</strong> <span class="badge bg-success">新增</span>
                                    </p>
                                    <ul class="mb-3">
                                        <li>适用对象：取证年限≥1年的老员工</li>
                                        <li>AFR = (失格次数 / 统计天数) × 365</li>
                                        <li>不同频率区间对应不同系数和标签</li>
                                        <li>示例：AFR≥2.5为"高频失格"，系数0.5（标准阈值）</li>
                                        <li><span class="text-info">老员工使用更严格的标准</span></li>
                                    </ul>

                                    <p class="mb-2"><code>training.duration_thresholds</code> - <strong>时长阈值</strong>
                                    </p>
                                    <ul class="mb-0">
                                        <li>short_term_days：短期统计天数（60天）</li>
                                        <li>mid_term_days：中期统计天数（180天）</li>
                                        <li>default_scores：无记录时的默认分数</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- 综合评分权重 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#weight-help">
                                    <strong>⚖️ 综合评分权重</strong>
                                </button>
                            </h2>
                            <div id="weight-help" class="accordion-collapse collapse" data-bs-parent="#paramHelp">
                                <div class="accordion-body" style="font-size: 0.9rem;">
                                    <p class="mb-2"><code>comprehensive.score_weights</code> - <strong>五维度权重配置</strong>
                                        <span class="badge bg-warning text-dark">已优化</span>
                                    </p>
                                    <ul class="mb-0">
                                        <li>performance：工作绩效权重（<del class="text-muted">原35%</del> →
                                            <strong>新15%</strong>，降低以提高区分度）
                                        </li>
                                        <li>safety：安全意识权重（<strong>保持30%</strong>，安全是底线）</li>
                                        <li>training：培训能力权重（<strong>保持25%</strong>，25%<30%满足要求）< /li>
                                        <li>stability：稳定性权重（<del class="text-muted">原10%</del> →
                                            <strong>新15%</strong>，提升重要性）
                                        </li>
                                        <li>learning：学习能力权重（<del class="text-muted">原5%</del> →
                                            <strong>新15%</strong>，提升重要性）
                                        </li>
                                        <li><strong class="text-danger">注意：五项权重之和必须等于1.0</strong></li>
                                        <li><span class="text-info">稳定性和学习能力权重可根据运行后的区分度调整（区分度高的+5%，低的-5%）</span></li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- 稳定性算法参数 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#stability-help">
                                    <strong>🏆 职业稳定性算法参数</strong> <span class="badge bg-success">全新</span>
                                </button>
                            </h2>
                            <div id="stability-help" class="accordion-collapse collapse" data-bs-parent="#paramHelp">
                                <div class="accordion-body" style="font-size: 0.9rem;">
                                    <p class="mb-2"><code>stability_new.window_months</code> - <strong>滚动窗口</strong></p>
                                    <ul class="mb-3">
                                        <li>6：更敏感（近期波动更重要）</li>
                                        <li>9：平衡</li>
                                        <li>12：更稳健（默认）</li>
                                    </ul>

                                    <p class="mb-2"><code>stability_new.volatility_metric</code> - <strong>波动指标</strong></p>
                                    <ul class="mb-3">
                                        <li>mean_abs_delta：月度变化幅度均值（推荐）</li>
                                        <li>mad：MAD（月度安全分）</li>
                                        <li>cv：CV（月度安全分）</li>
                                    </ul>

                                    <p class="mb-2"><code>stability_new.score_map_low</code> / <code>stability_new.score_map_high</code> - <strong>分位映射档位</strong></p>
                                    <ul class="mb-3">
                                        <li>严格：0.65 → 90 / 5.41 → 60</li>
                                        <li>标准：1.09 → 90 / 6.00 → 60</li>
                                        <li>宽松：1.46 → 90 / 7.32 → 60</li>
                                    </ul>

                                    <p class="mb-2"><code>stability_new.high_vol_threshold</code> - <strong>高波动阈值</strong></p>
                                    <ul class="mb-3">
                                        <li>高敏：0.0576（p70）</li>
                                        <li>标准：0.0667（p75）</li>
                                        <li>宽松：0.0855（p85）</li>
                                    </ul>

                                    <p class="mb-2"><code>stability_new.k_multiplier</code> - <strong>安全CV相对综合CV倍数</strong></p>
                                    <ul class="mb-3">
                                        <li>1.1：更敏感</li>
                                        <li>1.2：标准</li>
                                        <li>1.3：更严格</li>
                                    </ul>

                                    <p class="mb-2"><code>stability_new.label_cutoffs</code> - <strong>稳定度标签分段</strong></p>
                                    <ul class="mb-0">
                                        <li>严格：≥85 / 55–85 / &lt;55</li>
                                        <li>标准：≥75 / 60–75 / &lt;60</li>
                                        <li>宽松：≥70 / 55–70 / &lt;55</li>
                                    </ul>
                                </div>
                            </div>
                        </div>

                        <!-- 关键人员判定 -->
                        <div class="accordion-item">
                            <h2 class="accordion-header">
                                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse"
                                    data-bs-target="#key-help">
                                    <strong>🎯 关键人员判定标准</strong>
                                </button>
                            </h2>
                            <div id="key-help" class="accordion-collapse collapse" data-bs-parent="#paramHelp">
                                <div class="accordion-body" style="font-size: 0.9rem;">
                                    <p class="mb-2"><code>key_personnel</code> - <strong>关键关注人员标准</strong></p>
                                    <ul class="mb-0">
                                        <li>comprehensive_threshold：综合分数阈值（默认70分）</li>
                                        <li>低于此分数的人员被标记为关键关注对象</li>
                                        <li>monthly_violation_threshold：月度违规次数阈值（默认3次）</li>
                                        <li>超过此次数的人员被标记为关键关注对象</li>
                                        <li>作用：自动识别需要重点管理的人员</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="alert alert-info mt-3" role="alert">
                        <strong>💡 温馨提示：</strong>
                        <ul class="mb-0 mt-2">
                            <li>数值越小 = 惩罚越严格</li>
                            <li>建议先使用"模拟计算"测试效果</li>
                            <li>修改前建议记录变更原因</li>
                            <li>权重配置总和必须为1.0</li>
                        </ul>
                    </div>
                </div>
            </div>

            <hr class="my-4">

            <div class="mb-3">
                <label for="custom-reason" class="form-label">变更原因：<span class="text-danger">*</span></label>
                <input type="text" class="form-control" id="custom-reason" placeholder="请输入变更原因（必填）" required>
            </div>

            <div class="btn-group" role="group">
                <button type="button" class="btn btn-secondary" id="validate-config-btn">
                    <i class="bi bi-check2-square"></i> 验证配置
                </button>
                <button type="button" class="btn btn-info" id="effect-preview-btn">
                    <i class="bi bi-eye"></i> 效果预览
                </button>
                <button type="button" class="btn btn-success" id="save-custom-btn">
                    <i class="bi bi-save"></i> 保存自定义配置
                </button>
                <button type="button" class="btn btn-outline-secondary" id="reset-btn">
                    <i class="bi bi-arrow-counterclockwise"></i> 重置
                </button>
            </div>
        </div>
    </div>
</div>
</div>
</div>

<!-- 变更日志 -->
<div class="row mb-4">
    <div class="col-12">
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">变更日志</h5>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>时间</th>
                                <th>操作类型</th>
                                <th>预设方案</th>
                                <th>变更原因</th>
                                <th>操作者</th>
                                <th>IP地址</th>
                            </tr>
                        </thead>
                        <tbody id="logs-table-body">
                            <tr>
                                <td colspan="6" class="text-center">加载中...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
</div>

<!-- 模拟计算模态框 -->
<!-- 效果预览模态框 -->
<div class="modal fade" id="effectPreviewModal" tabindex="-1">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-info bg-opacity-10">
                <h5 class="modal-title">
                    <i class="bi bi-eye"></i> 配置效果预览
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <div id="preview-loading" class="text-center py-5">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">加载中...</span>
                    </div>
                    <p class="mt-3 text-muted">正在使用示例数据计算对比效果...</p>
                </div>

                <div id="preview-results" style="display: none;">
                    <!-- 人员信息 -->
                    <div class="alert alert-primary" role="alert">
                        <h6 class="mb-2"><i class="bi bi-person-badge"></i> 示例数据</h6>
                        <div id="employee-info"></div>
                        <small class="text-muted">（使用固定示例数据，便于对比不同配置的效果）</small>
                    </div>

                    <!-- 对比结果表格 -->
                    <div class="table-responsive">
                        <table class="table table-bordered table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th width="20%">维度</th>
                                    <th width="40%">当前配置</th>
                                    <th width="40%">新配置</th>
                                </tr>
                            </thead>
                            <tbody id="comparison-tbody">
                                <!-- 动态生成对比行 -->
                            </tbody>
                        </table>
                    </div>

                    <div class="alert alert-info mt-3" role="alert">
                        <i class="bi bi-info-circle"></i>
                        <strong>说明：</strong>
                        上表展示了同一人员在不同配置下的各维度分数对比。绿色表示分数提高，红色表示分数降低。
                    </div>
                </div>

                <div id="preview-error" style="display: none;">
                    <div class="alert alert-danger" role="alert">
                        <i class="bi bi-exclamation-triangle-fill"></i>
                        <span id="error-message"></span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">关闭</button>
            </div>
        </div>
    </div>
</div>

<script>
    let currentConfig = null;
    let selectedPreset = 'standard';

    // 页面加载时初始化
    document.addEventListener('DOMContentLoaded', function () {
        loadCurrentConfig();
        loadPresets();
        loadLogs();
    });

    // 加载当前配置
    function loadCurrentConfig() {
        fetch('/system/config/api/current-config')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    currentConfig = data.config;

                    // 显示配置信息
                    const info = data.info;

                    // 预设名称映射（英文 → 中文）
                    const presetNameMap = {
                        'strict': '严格档',
                        'standard': '标准档',
                        'lenient': '宽松档'
                    };
                    const presetDisplayName = info.based_on_preset
                        ? (presetNameMap[info.based_on_preset] || info.based_on_preset)
                        : '自定义';

                    let infoHtml = `
                    <p><strong>基于预设：</strong> ${presetDisplayName}</p>
                    <p><strong>是否已自定义：</strong> ${info.is_customized ? '是' : '否'}</p>
                    <p><strong>最后更新：</strong> ${info.updated_at || '未知'}</p>
                `;
                    document.getElementById('current-config-info').innerHTML = infoHtml;

                    // 填充JSON编辑器（旧版，保留用于兼容）
                    if (document.getElementById('config-json')) {
                        document.getElementById('config-json').value = JSON.stringify(currentConfig, null, 2);
                    }

                    // 填充可视化表单
                    loadConfigToForm(currentConfig);
                } else {
                    alert('加载配置失败: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('加载配置失败');
            });
    }

    // 将配置数据加载到可视化表单
    function loadConfigToForm(config) {
        // 辅助函数：安全获取嵌套对象的值
        function getNestedValue(obj, path) {
            return path.split('.').reduce((current, key) => {
                // 处理数组索引
                if (key.match(/^\d+$/)) {
                    return current?.[parseInt(key)];
                }
                return current?.[key];
            }, obj);
        }

        // 遍历所有带data-path属性的输入框
        document.querySelectorAll('[data-path]').forEach(input => {
            const path = input.getAttribute('data-path');
            let value = getNestedValue(config, path);

            if (value !== undefined && value !== null) {
                // 权重字段需要转换：小数 → 百分比 (0.35 → 35)
                if (input.classList.contains('weight-input')) {
                    value = value * 100;
                }
                input.value = value;
            }
        });

        // 稳定度：分位映射与标签档位的预设回填
        const stab = config.stability_new || {};
        const mapPreset = detectStabilityScoreMapPreset(stab);
        applyStabilityScoreMapPreset(mapPreset);
        const mapSelect = document.getElementById('stabilityScoreMapPreset');
        if (mapSelect) mapSelect.value = mapPreset;

        const labelPreset = detectStabilityLabelPreset(stab);
        applyStabilityLabelPreset(labelPreset);
        const labelSelect = document.getElementById('stabilityLabelPreset');
        if (labelSelect) labelSelect.value = labelPreset;

        // 更新权重总和显示
        updateWeightSum();

        // 初始化tooltip
        initTooltips();
    }

    function detectStabilityScoreMapPreset(stab) {
        const low = parseFloat(stab.score_map_low);
        const high = parseFloat(stab.score_map_high);
        if (Math.abs(low - 0.65) < 0.01 && Math.abs(high - 5.41) < 0.02) return 'strict';
        if (Math.abs(low - 1.09) < 0.02 && Math.abs(high - 6.0) < 0.02) return 'standard';
        if (Math.abs(low - 1.46) < 0.02 && Math.abs(high - 7.32) < 0.02) return 'lenient';
        return 'custom';
    }

    function applyStabilityScoreMapPreset(presetKey) {
        const presets = {
            strict: { low: 0.65, high: 5.41, hint: '严格：p20→90 (0.65) / p70→60 (5.41)' },
            standard: { low: 1.09, high: 6.00, hint: '标准：p25→90 (1.09) / p75→60 (6.00)' },
            lenient: { low: 1.46, high: 7.32, hint: '宽松：p30→90 (1.46) / p80→60 (7.32)' }
        };
        const lowInput = document.getElementById('stabilityScoreMapLow');
        const highInput = document.getElementById('stabilityScoreMapHigh');
        const hint = document.getElementById('stabilityScoreMapHint');

        if (!lowInput || !highInput || !hint) return;

        if (presetKey === 'custom') {
            const lowVal = lowInput.value || '--';
            const highVal = highInput.value || '--';
            hint.textContent = `自定义：${lowVal} → 90 / ${highVal} → 60`;
            return;
        }

        const preset = presets[presetKey] || presets.standard;
        lowInput.value = preset.low;
        highInput.value = preset.high;
        hint.textContent = preset.hint;
    }

    function detectStabilityLabelPreset(stab) {
        const stable = parseFloat(stab.label_cutoffs?.stable);
        const medium = parseFloat(stab.label_cutoffs?.medium);
        if (stable === 85 && medium === 55) return 'strict';
        if (stable === 75 && medium === 60) return 'standard';
        if (stable === 70 && medium === 55) return 'lenient';
        return 'custom';
    }

    function applyStabilityLabelPreset(presetKey) {
        const presets = {
            strict: { stable: 85, medium: 55, hint: '严格：≥85 / 55–85 / <55' },
            standard: { stable: 75, medium: 60, hint: '标准：≥75 / 60–75 / <60' },
            lenient: { stable: 70, medium: 55, hint: '宽松：≥70 / 55–70 / <55' }
        };
        const stableInput = document.getElementById('stabilityLabelStable');
        const mediumInput = document.getElementById('stabilityLabelMedium');
        const hint = document.getElementById('stabilityLabelHint');

        if (!stableInput || !mediumInput || !hint) return;

        if (presetKey === 'custom') {
            const stableVal = stableInput.value || '--';
            const mediumVal = mediumInput.value || '--';
            hint.textContent = `自定义：≥${stableVal} / ${mediumVal}–${stableVal} / <${mediumVal}`;
            return;
        }

        const preset = presets[presetKey] || presets.standard;
        stableInput.value = preset.stable;
        mediumInput.value = preset.medium;
        hint.textContent = preset.hint;
    }

    // 从可视化表单收集配置数据
    function collectFormData() {
        const config = {
            performance: {
                grade_coefficients: {},
                grade_ranges: {
                    D: { min: 0, max: 79.9, radar_override: 50 },
                    C: { min: 80, max: 89.9 },
                    B: { min: 90, max: 94.9 },
                    "B+": { min: 95, max: 99.9 },
                    A: { min: 100, max: 110 }
                },
                contamination_rules: {}
            },
            safety: {
                behavior_track: {
                    freq_thresholds: [],
                    freq_multipliers: []
                },
                severity_track: {
                    score_ranges: [
                        { max: 3, multiplier: 1.0 },
                        { min: 3, max: 5, multiplier: 2.5 },
                        { min: 5, multiplier: 5.0 }
                    ],
                    critical_threshold: 12
                },
                thresholds: {
                    fail_score: 60,
                    warning_score: 90
                }
            },
            training: {
                penalty_rules: {
                    absolute_threshold: {},
                    small_sample: {},
                    afr_thresholds: [
                        { min: 2.5, coefficient: 0.5, label: "高频失格" },
                        { min: 1.5, max: 2.5, coefficient: 0.7, label: "频率偏高" },
                        { min: 0.5, max: 1.5, coefficient: 0.9, label: "偶发失格" }
                    ]
                },
                duration_thresholds: {
                    short_term_days: 60,
                    mid_term_days: 180,
                    default_scores: { short: 65, mid: 50, long: 0 }
                }
            },
            comprehensive: {
                score_weights: {}
            },
            key_personnel: {},
            learning: {
                potential_threshold: 0.5,
                decline_threshold: -0.2,
                decline_penalty: 0.8,
                slope_amplifier: 10
            },
            learning_new: {},
            stability_new: {
                label_cutoffs: {}
            },
            nine_grid: {
                y_axis_weights: {}
            }
        };

        // 辅助函数：设置嵌套对象的值
        function setNestedValue(obj, path, value) {
            const keys = path.split('.');
            const lastKey = keys.pop();
            const target = keys.reduce((current, key) => {
                if (key.match(/^\d+$/)) {
                    const index = parseInt(key);
                    if (!Array.isArray(current)) return current;
                    return current[index];
                }
                return current[key];
            }, obj);

            if (lastKey.match(/^\d+$/)) {
                target[parseInt(lastKey)] = value;
            } else {
                target[lastKey] = value;
            }
        }

        // 从表单收集数据
        document.querySelectorAll('[data-path]').forEach(input => {
            const path = input.getAttribute('data-path');
            let value = input.value;

            // 转换数据类型
            if (input.type === 'number' || input.getAttribute('data-value-type') === 'number') {
                value = parseFloat(value);

                // 权重字段需要转换：百分比 → 小数 (35 → 0.35)
                if (input.classList.contains('weight-input')) {
                    value = value / 100;
                }
            }

            setNestedValue(config, path, value);
        });

        return config;
    }

    // 更新权重总和显示
    function updateWeightSum() {
        const weights = document.querySelectorAll('.weight-input');
        let sum = 0;

        weights.forEach(input => {
            const value = parseFloat(input.value) || 0;
            sum += value;
        });

        const sumDisplay = document.getElementById('weight-sum');
        const statusDisplay = document.getElementById('weight-status');

        sum = Math.round(sum * 10) / 10; // 保留1位小数
        sumDisplay.textContent = sum.toFixed(1) + '%';

        if (Math.abs(sum - 100.0) < 1) {
            statusDisplay.innerHTML = '<span class="badge bg-success"><i class="bi bi-check-circle"></i> 正确</span>';
        } else {
            statusDisplay.innerHTML = '<span class="badge bg-danger"><i class="bi bi-x-circle"></i> 错误</span>';
        }
    }

    // 初始化tooltips
    function initTooltips() {
        const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        tooltipTriggerList.map(function (tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });
    }

    // 监听权重输入变化
    document.addEventListener('DOMContentLoaded', function () {
        document.querySelectorAll('.weight-input').forEach(input => {
            input.addEventListener('input', updateWeightSum);
        });
    });

    // 稳定度预设选择联动
    document.addEventListener('DOMContentLoaded', function () {
        const scoreMapSelect = document.getElementById('stabilityScoreMapPreset');
        if (scoreMapSelect) {
            scoreMapSelect.addEventListener('change', function () {
                applyStabilityScoreMapPreset(this.value);
            });
        }

        const labelSelect = document.getElementById('stabilityLabelPreset');
        if (labelSelect) {
            labelSelect.addEventListener('change', function () {
                applyStabilityLabelPreset(this.value);
            });
        }
    });

    // 保存自定义配置
    document.addEventListener('DOMContentLoaded', function () {
        const saveBtn = document.getElementById('save-custom-config-btn');
        if (saveBtn) {
            saveBtn.addEventListener('click', function () {
                const reason = document.getElementById('custom-reason').value.trim();
                if (!reason) {
                    alert('请填写变更原因');
                    return;
                }

                // 验证权重总和
                const weights = document.querySelectorAll('.weight-input');
                let sum = 0;
                weights.forEach(input => {
                    sum += parseFloat(input.value) || 0;
                });

                if (Math.abs(sum - 100.0) > 1) {
                    alert('权重总和必须等于100%！当前总和：' + sum.toFixed(1) + '%');
                    return;
                }

                // 收集表单数据
                const configData = collectFormData();

                if (!confirm('确定要保存自定义配置吗？')) {
                    return;
                }

                // 发送保存请求
                fetch('/system/config/api/update-config', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        config_data: configData,
                        reason: reason
                    })
                })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            alert('✅ 保存成功！配置已生效。');
                            location.reload();
                        } else {
                            alert('❌ 保存失败: ' + data.error);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        alert('❌ 保存失败，请重试');
                    });
            });
        }
    });

    // 重置配置
    document.addEventListener('DOMContentLoaded', function () {
        const resetBtn = document.getElementById('reset-custom-config-btn');
        if (resetBtn) {
            resetBtn.addEventListener('click', function () {
                if (confirm('确定要重置为当前生效的配置吗？')) {
                    loadConfigToForm(currentConfig);
                    alert('已重置');
                }
            });
        }
    });

    // 效果预览（主按钮）
    document.addEventListener('DOMContentLoaded', function () {
        const mainPreviewBtn = document.getElementById('effect-preview-btn-main');
        if (mainPreviewBtn) {
            mainPreviewBtn.addEventListener('click', function () {
                showEffectPreview();
            });
        }
    });

    // 加载预设方案
    function loadPresets() {
        fetch('/system/config/api/presets')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const container = document.getElementById('preset-options');
                    container.innerHTML = '';

                    data.presets.forEach(preset => {
                        const cfg = preset.config_data;
                        const perf = cfg.performance || {};
                        const safety = cfg.safety || {};
                        const training = cfg.training || {};
                        const stab = cfg.stability_new || {};
                        const learn = cfg.learning_new || {};
                        const key = cfg.key_personnel || {};

                        // --- 1. 绩效参数 ---
                        const pCoeffs = perf.grade_coefficients || {};
                        const pRules = perf.contamination_rules || {};
                        const dThresh = pRules.d_count_threshold ?? 1;
                        const dCap = pRules.d_cap_score ?? 90;
                        const cThresh = pRules.c_count_threshold ?? 2;
                        const cCap = pRules.c_cap_score ?? 95;

                        // --- 2. 安全参数 ---
                        const sBehav = safety.behavior_track || {};
                        const sSever = safety.severity_track || {};
                        const fThresh = sBehav.freq_thresholds || [2, 5, 6];
                        const fMult = sBehav.freq_multipliers || [2, 5, 10];
                        const sRanges = sSever.score_ranges || [];
                        const r0 = sRanges[0] || {};
                        const r1 = sRanges[1] || {};
                        const r2 = sRanges[2] || {};
                        const r0Max = r0.max ?? 3;
                        const r0Mult = r0.multiplier ?? 1.0;
                        const r1Min = r1.min ?? 3;
                        const r1Max = r1.max ?? 5;
                        const r1Mult = r1.multiplier ?? 2.5;
                        const r2Min = r2.min ?? 5;
                        const r2Mult = r2.multiplier ?? 5.0;
                        const sCrit = sSever.critical_threshold ?? 12;

                        // --- 3. 培训参数 ---
                        const tRules = training.penalty_rules || {};
                        const tAbs = tRules.absolute_threshold || {};
                        const tSmall = tRules.small_sample || {};
                        const tAfr = tRules.afr_thresholds || [];
                        const afr0 = tAfr[0] || { min: 2.5, coefficient: 0.5 };

                        // --- 4. 稳定度参数 ---
                        const stWindow = stab.window_months ?? 12;
                        const stMetric = stab.volatility_metric ?? 'mean_abs_delta';
                        const stMetricLabel = stMetric === 'mean_abs_delta' ? 'Mean |Δ|' : (stMetric === 'mad' ? 'MAD' : (stMetric === 'cv' ? 'CV' : stMetric));
                        const stMapLow = stab.score_map_low ?? 1.09;
                        const stMapHigh = stab.score_map_high ?? 6.0;
                        const stHighVol = stab.high_vol_threshold ?? 0.0667;
                        const stK = stab.k_multiplier ?? 1.2;
                        const stLabelStable = stab.label_cutoffs?.stable ?? 75;
                        const stLabelMedium = stab.label_cutoffs?.medium ?? 60;

                        // --- 5. 安全趋势参数 ---
                        const lCeiling = learn.trend_ceiling_floor ?? 5;
                        const lRatio = learn.trend_warning_ratio ?? 1.5;
                        const lWarnFloor = learn.trend_warning_floor ?? 2;
                        const lBaseLine = learn.historical_baseline ?? 3;
                        const lCritRatio = learn.trend_critical_ratio ?? 3.0;
                        const lCritFloor = learn.trend_critical_floor ?? 5;
                        const lReward = learn.factor_reward ?? learn.factor_improvement ?? 1.2;
                        const lStable = learn.factor_stable ?? 1.0;
                        const lSafeFluct = learn.factor_safe_fluctuation ?? 0.9;
                        const lMitigation = learn.factor_mitigation ?? learn.factor_high_improvement ?? 0.8;
                        const lWarning = learn.factor_warning ?? 0.6;
                        const lSolid = learn.factor_solidification ?? 0.4;
                        const lDeterioration = learn.factor_deterioration ?? 0.3;
                        const lInertiaStart = learn.inertia_start_months ?? 2;
                        const lInertiaStep = learn.inertia_step ?? 0.15;
                        const lInertiaMax = learn.inertia_max_penalty ?? 0.6;
                        const lDecay = learn.time_decay_rate ?? 0.2;

                        const card = `
                        <div class="col-md-4">
                            <div class="card preset-card h-100" data-preset="${preset.preset_key}" style="cursor: pointer; border: 1px solid rgba(0,0,0,0.1);">
                                <div class="card-header bg-${preset.preset_key === 'strict' ? 'danger' : preset.preset_key === 'standard' ? 'primary' : 'success'} text-white py-2">
                                    <h6 class="mb-0 text-center"><strong>${preset.preset_name}</strong></h6>
                                </div>
                                <div class="card-body p-3" style="font-size: 0.8rem; overflow-y: auto; max-height: 650px;">
                                    <p class="text-muted text-center mb-3 small">"${preset.description}"</p>

                                    <!-- 1. 绩效 -->
                                    <div class="mb-3">
                                        <h6 class="text-primary fw-bold border-bottom pb-1 mb-2">1. 工作绩效 (Performance)</h6>
                                        <div class="ps-2 text-muted">
                                            <div class="mb-1"><strong>单月公式：</strong>系数 × 基准(95)</div>
                                            <div class="mb-2 ps-3 small">
                                                A=${pCoeffs.A ?? 1.1}, B=${pCoeffs.B ?? 0.9}, C=${pCoeffs.C ?? 0.6}, D=${pCoeffs.D ?? 0.0}
                                            </div>
                                            <div class="mb-1"><strong>长周期(熔断)：</strong></div>
                                            <ul class="mb-0 ps-3 small">
                                                <li>D级≥${dThresh}次 → 上限${dCap}分</li>
                                                <li>C级≥${cThresh}次 → 上限${cCap}分</li>
                                            </ul>
                                        </div>
                                    </div>

                                    <!-- 2. 安全 -->
                                    <div class="mb-3">
                                        <h6 class="fw-bold border-bottom pb-1 mb-2" style="color: #fd7e14;">2. 安全意识 (Safety)</h6>
                                        <div class="ps-2 text-muted">
                                            <div class="mb-1"><strong>单月(双轨取低)：</strong></div>
                                            <ul class="mb-0 ps-3 small">
                                                <li>频率轨: ≤${fThresh[0]}次(x${fMult[0]}), ≤${fThresh[1]}次(x${fMult[1]}), >${fThresh[1]}次(x${fMult[2]})</li>
                                                <li>严重轨: &lt;${r0Max}(x${r0Mult}), ${r1Min}-${r1Max}(x${r1Mult}), ≥${r2Min}(x${r2Mult})</li>
                                                <li class="text-danger">红线: 单次≥${sCrit}分 → 0分</li>
                                            </ul>
                                        </div>
                                    </div>

                                    <!-- 3. 培训 -->
                                    <div class="mb-3">
                                        <h6 class="text-success fw-bold border-bottom pb-1 mb-2">3. 培训能力 (Training)</h6>
                                        <div class="ps-2 text-muted">
                                            <div class="mb-1"><strong>单月(惩罚)：</strong></div>
                                            <ul class="mb-0 ps-3 small">
                                                <li>绝对失格: ≥${tAbs.fail_count ?? 3}次 → 系数x${tAbs.coefficient ?? 0.5}</li>
                                                <li>小样本: &lt;${tSmall.sample_size ?? 10}次 → 系数x${tSmall.coefficient ?? 0.7}</li>
                                            </ul>
                                            <div class="mb-1 mt-1"><strong>长周期(AFR)：</strong></div>
                                            <div class="ps-3 small">
                                                高频(≥${afr0.min}) → 系数x${afr0.coefficient}
                                            </div>
                                        </div>
                                    </div>

                                    <!-- 4. 稳定度 -->
                                    <div class="mb-3">
                                        <h6 class="text-secondary fw-bold border-bottom pb-1 mb-2">4. 职业稳定度 (Stability)</h6>
                                        <div class="ps-2 text-muted">
                                            <div class="mb-1"><strong>滚动窗口：</strong>${stWindow}个月</div>
                                            <div class="mb-1"><strong>波动指标：</strong>${stMetricLabel}</div>
                                            <div class="mb-1"><strong>分位映射：</strong>${stMapLow} → 90 / ${stMapHigh} → 60</div>
                                            <div class="mb-1"><strong>高波动阈值：</strong>${stHighVol}</div>
                                            <div class="mb-1"><strong>倍数系数：</strong>${stK}</div>
                                            <div class="mb-1"><strong>标签分段：</strong>≥${stLabelStable} / ${stLabelMedium}–${stLabelStable} / &lt;${stLabelMedium}</div>
                                        </div>
                                    </div>

                                    <!-- 5. 安全趋势 -->
                                    <div class="mb-3">
                                        <h6 class="text-info fw-bold border-bottom pb-1 mb-2">5. 安全趋势 (Trend)</h6>
                                        <div class="ps-2 text-muted">
                                            <div class="mb-1"><strong>水位线(动态)：</strong></div>
                                            <ul class="mb-0 ps-3 small">
                                                <li>关注线 = min(max(均值x${lRatio}, ${lWarnFloor}, ${lBaseLine}), ${lCeiling})</li>
                                                <li>熔断线 = max(均值x${lCritRatio}, ${lCritFloor})</li>
                                            </ul>
                                            <div class="mb-1 mt-1"><strong>区间系数：</strong></div>
                                            <ul class="mb-0 ps-3 small">
                                                <li>安全区: 奖励x${lReward}, 稳定x${lStable}, 波动x${lSafeFluct}</li>
                                                <li>危险区: 改善x${lMitigation}, 冷启动x${lWarning}, 固化x${lSolid}, 恶化x${lDeterioration}</li>
                                            </ul>
                                            <div class="mb-1 mt-1"><strong>风险惯性：</strong></div>
                                            <div class="ps-3 small">
                                                连续≥${lInertiaStart}月 → 惯性=min((K-启动+1)x${lInertiaStep}, 上限${lInertiaMax})
                                            </div>
                                            <div class="mb-1 mt-1"><strong>长周期聚合：</strong></div>
                                            <div class="ps-3 small">
                                                时间衰减: ${lDecay}
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        `;
                        container.innerHTML += card;
                    });

                    // 添加点击事件
                    document.querySelectorAll('.preset-card').forEach(card => {
                        card.addEventListener('click', function () {
                            // 移除其他选中状态
                            document.querySelectorAll('.preset-card').forEach(c => {
                                c.classList.remove('border-primary', 'bg-light');
                            });
                            // 添加选中状态
                            this.classList.add('border-primary', 'bg-light');
                            selectedPreset = this.dataset.preset;
                        });
                    });

                    // 默认选中标准档
                    const standardCard = document.querySelector('[data-preset="standard"]');
                    if (standardCard) {
                        standardCard.click();
                    }
                }
            });
    }

    // 加载变更日志
    function loadLogs() {
        fetch('/system/config/api/change-logs')
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    const tbody = document.getElementById('logs-table-body');
                    tbody.innerHTML = '';

                    if (data.logs.length === 0) {
                        tbody.innerHTML = '<tr><td colspan="6" class="text-center text-muted">暂无日志记录</td></tr>';
                        return;
                    }

                    data.logs.forEach(log => {
                        const row = `
                        <tr>
                            <td>${log.changed_at}</td>
                            <td><span class="badge bg-info">${log.action}</span></td>
                            <td>${log.preset_name || '-'}</td>
                            <td>${log.change_reason}</td>
                            <td>${log.changed_by_name}</td>
                            <td>${log.ip_address || '-'}</td>
                        </tr>
                    `;
                        tbody.innerHTML += row;
                    });
                }
            });
    }

    // 应用预设方案
    document.getElementById('apply-preset-btn').addEventListener('click', function () {
        const reason = document.getElementById('preset-reason').value.trim();
        if (!reason) {
            alert('请填写变更原因');
            return;
        }

        if (!confirm(`确定要应用"${selectedPreset}"预设方案吗？`)) {
            return;
        }

        fetch('/system/config/api/apply-preset', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                preset_key: selectedPreset,
                reason: reason
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('应用成功！');
                    location.reload();
                } else {
                    alert('应用失败: ' + data.error);
                }
            });
    });

    // 验证配置
    document.getElementById('validate-config-btn').addEventListener('click', function () {
        // 从可视化表单收集配置
        const configData = collectFormData();

        // 验证权重总和
        const weights = configData.comprehensive.score_weights;
        const weightSum = Object.values(weights).reduce((a, b) => a + b, 0);
        if (Math.abs(weightSum - 1.0) > 0.01) {
            alert('❌ 权重总和必须等于100%！当前总和：' + (weightSum * 100).toFixed(1) + '%');
            return;
        }

        fetch('/system/config/api/validate-config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ config_data: configData })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success && data.is_valid) {
                    alert('✅ 配置验证通过！');
                } else {
                    alert('❌ 配置验证失败：' + data.message);
                }
            })
            .catch(error => {
                alert('验证失败: ' + error.message);
            });
    });

    // 保存自定义配置
    document.getElementById('save-custom-btn').addEventListener('click', function () {
        const reason = document.getElementById('custom-reason').value.trim();
        if (!reason) {
            alert('请填写变更原因');
            return;
        }

        // 从可视化表单收集配置
        const configData = collectFormData();

        // 验证权重总和
        const weights = configData.comprehensive.score_weights;
        const weightSum = Object.values(weights).reduce((a, b) => a + b, 0);
        if (Math.abs(weightSum - 1.0) > 0.01) {
            alert('❌ 权重总和必须等于100%！当前总和：' + (weightSum * 100).toFixed(1) + '%');
            return;
        }

        if (!confirm('确定要保存自定义配置吗？')) {
            return;
        }

        fetch('/system/config/api/update-config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                config_data: configData,
                reason: reason
            })
        })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    alert('✅ 保存成功！配置已生效。');
                    location.reload();
                } else {
                    alert('❌ 保存失败: ' + data.error);
                }
            })
            .catch(error => {
                alert('保存失败: ' + error.message);
            });
    });

    // 重置配置
    document.getElementById('reset-btn').addEventListener('click', function () {
        if (confirm('确定要重置为当前生效的配置吗？')) {
            loadCurrentConfig();
        }
    });

    // 效果预览
    document.getElementById('effect-preview-btn').addEventListener('click', function () {
        showEffectPreview();
    });

    function showEffectPreview() {
        // 使用 getOrCreateInstance 避免创建多个实例
        const modalElement = document.getElementById('effectPreviewModal');
        const modal = bootstrap.Modal.getOrCreateInstance(modalElement);
        modal.show();

        // 显示加载状态
        document.getElementById('preview-loading').style.display = 'block';
        document.getElementById('preview-results').style.display = 'none';
        document.getElementById('preview-error').style.display = 'none';

        // 收集新配置
        const newConfig = collectFormData();

        // 调用API
        fetch('/system/config/api/preview-effect', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                config_data: newConfig
            })
        })
            .then(response => response.json())
            .then(data => {
                // 隐藏加载状态
                document.getElementById('preview-loading').style.display = 'none';

                if (data.success) {
                    displayPreviewResults(data.result);
                } else {
                    document.getElementById('preview-error').style.display = 'block';
                    document.getElementById('error-message').textContent = data.error;
                }
            })
            .catch(error => {
                document.getElementById('preview-loading').style.display = 'none';
                document.getElementById('preview-error').style.display = 'block';
                document.getElementById('error-message').textContent = '网络错误: ' + error.message;
            });
    }

    function displayPreviewResults(result) {
        // 显示人员信息
        const empInfo = `
                                                                                                                                        <strong>姓名：</strong>${result.employee_name} &nbsp;&nbsp;
                                                                                                                                        <strong>工号：</strong>${result.employee_id} &nbsp;&nbsp;
                                                                                                                                        <strong>部门：</strong>${result.department_id || '未知'}
                                                                                                                                        `;
        document.getElementById('employee-info').innerHTML = empInfo;

        // 生成对比表格
        let tbody = '';

        // 绩效维度
        if (result.current.performance) {
            const curr = result.current.performance;
            const newP = result.new.performance;
            const diff = newP.final_score - curr.final_score;
            const diffClass = diff > 0 ? 'text-success' : (diff < 0 ? 'text-danger' : '');
            const diffIcon = diff > 0 ? '↑' : (diff < 0 ? '↓' : '');

            tbody += `
                                                                                                                                        <tr>
                                                                                                                                            <td><strong>📊 工作绩效</strong></td>
                                                                                                                                            <td>
                                                                                                                                                等级：<span class="badge bg-secondary">${curr.grade}</span><br>
                                                                                                                                                    系数：${curr.coefficient.toFixed(2)}<br>
                                                                                                                                                        得分：<strong>${curr.final_score.toFixed(1)}</strong>
                                                                                                                                                    </td>
                                                                                                                                                    <td>
                                                                                                                                                        等级：<span class="badge bg-secondary">${newP.grade}</span><br>
                                                                                                                                                            系数：${newP.coefficient.toFixed(2)}<br>
                                                                                                                                                                得分：<strong class="${diffClass}">${newP.final_score.toFixed(1)}${diff !== 0 ? ` ${diffIcon}${Math.abs(diff).toFixed(1)}` : ''}</strong>
                                                                                                                                                            </td>
                                                                                                                                                        </tr>
                                                                                                                                                        `;
        }

        // 安全维度
        if (result.current.safety) {
            const curr = result.current.safety;
            const newS = result.new.safety;
            const diff = newS.final_score - curr.final_score;
            const diffClass = diff > 0 ? 'text-success' : (diff < 0 ? 'text-danger' : '');
            const diffIcon = diff > 0 ? '↑' : (diff < 0 ? '↓' : '');

            tbody += `
                                                                                                                                                        <tr>
                                                                                                                                                            <td><strong>🛡️ 安全意识</strong></td>
                                                                                                                                                            <td>
                                                                                                                                                                违规记录：${curr.violations_detail}<br>
                                                                                                                                                                    违规次数：${curr.violations_count}次<br>
                                                                                                                                                                        维度A（频率）：${curr.dimension_a.toFixed(1)}分<br>
                                                                                                                                                                            维度B（严重性）：${curr.dimension_b.toFixed(1)}分<br>
                                                                                                                                                                                得分：<strong>${curr.final_score.toFixed(1)}</strong>
                                                                                                                                                                            </td>
                                                                                                                                                                            <td>
                                                                                                                                                                                违规记录：${newS.violations_detail}<br>
                                                                                                                                                                                    违规次数：${newS.violations_count}次<br>
                                                                                                                                                                                        维度A（频率）：${newS.dimension_a.toFixed(1)}分<br>
                                                                                                                                                                                            维度B（严重性）：${newS.dimension_b.toFixed(1)}分<br>
                                                                                                                                                                                                得分：<strong class="${diffClass}">${newS.final_score.toFixed(1)}${diff !== 0 ? ` ${diffIcon}${Math.abs(diff).toFixed(1)}` : ''}</strong>
                                                                                                                                                                                            </td>
                                                                                                                                                                                        </tr>
                                                                                                                                                                                        `;
        }

        // 培训维度
        if (result.current.training) {
            const curr = result.current.training;
            const newT = result.new.training;
            const diff = newT.final_score - curr.final_score;
            const diffClass = diff > 0 ? 'text-success' : (diff < 0 ? 'text-danger' : '');
            const diffIcon = diff > 0 ? '↑' : (diff < 0 ? '↓' : '');

            tbody += `
                                                                                                                                                                                        <tr>
                                                                                                                                                                                            <td><strong>🎓 培训能力</strong></td>
                                                                                                                                                                                            <td>
                                                                                                                                                                                                培训记录：${curr.records_count}次（合格${curr.qualified_count}次）<br>
                                                                                                                                                                                                    平均分：${curr.avg_score.toFixed(1)}分<br>
                                                                                                                                                                                                        惩罚系数：${curr.penalty_coefficient.toFixed(2)}<br>
                                                                                                                                                                                                            得分：<strong>${curr.final_score.toFixed(1)}</strong>
                                                                                                                                                                                                        </td>
                                                                                                                                                                                                        <td>
                                                                                                                                                                                                            培训记录：${newT.records_count}次（合格${newT.qualified_count}次）<br>
                                                                                                                                                                                                                平均分：${newT.avg_score.toFixed(1)}分<br>
                                                                                                                                                                                                                    惩罚系数：${newT.penalty_coefficient.toFixed(2)}<br>
                                                                                                                                                                                                                        得分：<strong class="${diffClass}">${newT.final_score.toFixed(1)}${diff !== 0 ? ` ${diffIcon}${Math.abs(diff).toFixed(1)}` : ''}</strong>
                                                                                                                                                                                                                    </td>
                                                                                                                                                                                                                </tr>
                                                                                                                                                                                                                `;
        }

        // 学习能力维度
        if (result.current.learning) {
            const curr = result.current.learning;
            const newL = result.new.learning;
            const diff = newL.final_score - curr.final_score;
            const diffClass = diff > 0 ? 'text-success' : (diff < 0 ? 'text-danger' : '');
            const diffIcon = diff > 0 ? '↑' : (diff < 0 ? '↓' : '');

            // 定级badge颜色
            // 风险等级颜色映射
            const riskColorMap = {
                'SAFE': 'success',
                'WATCH_LIST': 'warning',
                'HIGH_RISK': 'danger',
                'PRE_ACCIDENT': 'dark',
                'UNKNOWN': 'secondary'
            };
            const riskNameMap = {
                'SAFE': '安全',
                'WATCH_LIST': '重点关注',
                'HIGH_RISK': '高危',
                'PRE_ACCIDENT': '事故前兆',
                'UNKNOWN': '未知'
            };

            const currRiskColor = riskColorMap[curr.risk_level] || 'secondary';
            const newRiskColor = riskColorMap[newL.risk_level] || 'secondary';
            const currRiskName = riskNameMap[curr.risk_level] || curr.risk_level;
            const newRiskName = riskNameMap[newL.risk_level] || newL.risk_level;

            tbody += `
                <tr>
                    <td><strong>📉 安全趋势</strong><br><small class="text-muted">(原学习能力)</small></td>
                    <td>
                        风险级：<span class="badge bg-${currRiskColor}">${currRiskName}</span><br>
                        惯性扣减：${curr.inertia_penalty || '0%'}<br>
                        <small class="text-muted">${curr.trend_description}</small><br>
                        得分：<strong>${curr.final_score.toFixed(1)}</strong>
                    </td>
                    <td>
                        风险级：<span class="badge bg-${newRiskColor}">${newRiskName}</span><br>
                        惯性扣减：${newL.inertia_penalty || '0%'}<br>
                        <small class="text-muted">${newL.trend_description}</small><br>
                        得分：<strong class="${diffClass}">${newL.final_score.toFixed(1)}${diff !== 0 ? ` ${diffIcon}${Math.abs(diff).toFixed(1)}` : ''}</strong>
                    </td>
                </tr>
            `;
        }

        document.getElementById('comparison-tbody').innerHTML = tbody;
        document.getElementById('preview-results').style.display = 'block';
    }
</script>

<style>
    .preset-card {
        transition: all 0.3s;
        border: 2px solid transparent;
    }

    .preset-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }

    .preset-card.border-primary {
        border: 2px solid #0d6efd !important;
    }
</style>
{% endblock %}
