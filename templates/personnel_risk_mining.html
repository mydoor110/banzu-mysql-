{% extends "base.html" %}

{% block extra_css %}
<style>
    .risk-card {
        transition: transform 0.2s;
    }
    .risk-card:hover {
        transform: translateY(-2px);
    }
    .risk-score {
        font-size: 2rem;
        font-weight: bold;
    }
    .risk-high { color: #dc3545; }
    .risk-medium { color: #fd7e14; }
    .risk-low { color: #198754; }
    .risk-badge {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        font-size: 0.75rem;
    }
    .anomaly-badge {
        background-color: #6f42c1;
        color: white;
    }
    .factor-tag {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        margin: 0.1rem;
        background-color: #e9ecef;
        border-radius: 0.25rem;
        font-size: 0.8rem;
    }
    .ai-diagnosis {
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.5rem;
        padding: 1rem;
        margin-top: 1rem;
    }
    .ai-diagnosis-header {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 0.75rem 1rem;
        border-radius: 0.5rem 0.5rem 0 0;
        margin: -1rem -1rem 1rem -1rem;
        font-weight: 600;
    }
    .ai-section {
        margin-bottom: 1rem;
        padding: 0.75rem;
        background: white;
        border-radius: 0.375rem;
        border-left: 3px solid;
    }
    .ai-section:last-child {
        margin-bottom: 0;
    }
    .ai-section-risk { border-left-color: #dc3545; }
    .ai-section-training { border-left-color: #fd7e14; }
    .ai-section-root { border-left-color: #6f42c1; }
    .ai-section-predict { border-left-color: #0dcaf0; }
    .ai-section-action { border-left-color: #198754; }
    .ai-section-title {
        font-weight: 600;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        gap: 0.5rem;
    }
    .ai-section-content {
        color: #495057;
        font-size: 0.9rem;
        line-height: 1.6;
    }
    .ai-tag {
        display: inline-block;
        padding: 0.2rem 0.5rem;
        margin: 0.1rem;
        background-color: #e9ecef;
        border-radius: 0.25rem;
        font-size: 0.8rem;
    }
    .ai-tag-severe {
        background-color: #f8d7da;
        color: #842029;
    }
    .ai-root-type {
        display: inline-block;
        padding: 0.25rem 0.75rem;
        border-radius: 1rem;
        font-weight: 600;
        font-size: 0.85rem;
    }
    .ai-root-skill { background-color: #cfe2ff; color: #084298; }
    .ai-root-habit { background-color: #fff3cd; color: #664d03; }
    .ai-root-state { background-color: #f8d7da; color: #842029; }
    .ai-measure {
        display: flex;
        align-items: flex-start;
        gap: 0.5rem;
        margin-bottom: 0.5rem;
    }
    .ai-measure:last-child {
        margin-bottom: 0;
    }
    .ai-measure-icon {
        color: #198754;
        font-weight: bold;
    }
    .ai-mode-toggle {
        display: flex;
        justify-content: flex-end;
        margin-bottom: 0.75rem;
    }
    .ai-mode-btn {
        background: none;
        border: 1px solid #dee2e6;
        padding: 0.25rem 0.75rem;
        font-size: 0.8rem;
        cursor: pointer;
        border-radius: 0.25rem;
        color: #6c757d;
    }
    .ai-mode-btn:hover {
        background-color: #f8f9fa;
    }
    .ai-brief-summary {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        border-radius: 0.5rem;
        padding: 1rem;
    }
    .ai-brief-conclusion {
        font-size: 1rem;
        margin-bottom: 0.75rem;
        padding-bottom: 0.75rem;
        border-bottom: 1px dashed #dee2e6;
    }
    .ai-brief-row {
        display: flex;
        gap: 1rem;
        margin-bottom: 0.5rem;
    }
    .ai-brief-label {
        font-weight: 600;
        color: #495057;
        min-width: 80px;
    }
    .ai-detail-section {
        display: none;
    }
    .ai-detail-section.show {
        display: block;
    }
    .wordcloud-container {
        min-height: 300px;
        display: flex;
        flex-wrap: wrap;
        align-items: center;
        justify-content: center;
        gap: 0.5rem;
        padding: 1rem;
    }
    .wordcloud-word {
        padding: 0.25rem 0.5rem;
        border-radius: 0.25rem;
        background-color: #e7f1ff;
        color: #0d6efd;
        cursor: default;
    }
    .survival-chart {
        min-height: 300px;
    }
    .summary-stat {
        text-align: center;
        padding: 1rem;
    }
    .summary-stat h3 {
        font-size: 2.5rem;
        margin-bottom: 0.25rem;
    }
    .summary-stat p {
        color: #6c757d;
        margin-bottom: 0;
    }
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background: rgba(255,255,255,0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 9999;
    }
    .employee-table th, .employee-table td {
        vertical-align: middle;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>é«˜é£é™©äººå‘˜æŒ–æ˜</h2>
    <nav aria-label="breadcrumb">
        <ol class="breadcrumb mb-0">
            <li class="breadcrumb-item"><a href="{{ url_for('personnel.dashboard') }}">äººå‘˜ç®¡ç†</a></li>
            <li class="breadcrumb-item active">é£é™©æŒ–æ˜</li>
        </ol>
    </nav>
</div>

<!-- ç­›é€‰æ¡ä»¶ -->
<div class="card mb-4">
    <div class="card-body">
        <div class="row align-items-end">
            <div class="col-md-4 mb-2">
                <label class="form-label">å¼€å§‹æ—¥æœŸ</label>
                <input type="month" class="form-control" id="start-date">
            </div>
            <div class="col-md-4 mb-2">
                <label class="form-label">ç»“æŸæ—¥æœŸ</label>
                <input type="month" class="form-control" id="end-date">
            </div>
            <div class="col-md-4 mb-2">
                <button class="btn btn-primary w-100" id="analyze-btn">
                    å¼€å§‹é£é™©åˆ†æ
                </button>
            </div>
        </div>
        <div class="row mt-2">
            <div class="col-12">
                <small class="text-muted">
                    ğŸ’¡ <strong>çœTokenæ¨¡å¼</strong>ï¼šç®—æ³•åˆç­›å…è´¹ â†’ é«˜é£é™©äººå‘˜æ˜¾ç¤ºAIæŒ‰é’® â†’ ç‚¹å‡»åå…ˆæŸ¥ç¼“å­˜ â†’ ä»…æ— ç¼“å­˜æ—¶è°ƒç”¨AI
                </small>
            </div>
        </div>
    </div>
</div>

<!-- ç»Ÿè®¡æ‘˜è¦ -->
<div class="row mb-4" id="summary-row" style="display: none;">
    <div class="col-md-3">
        <div class="card">
            <div class="card-body summary-stat">
                <h3 id="stat-total" class="text-primary">-</h3>
                <p>åˆ†æäººæ•°</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body summary-stat">
                <h3 id="stat-high-risk" class="text-danger">-</h3>
                <p>é«˜é£é™©äººå‘˜</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body summary-stat">
                <h3 id="stat-anomaly" class="text-warning">-</h3>
                <p>å¼‚å¸¸æ£€æµ‹</p>
            </div>
        </div>
    </div>
    <div class="col-md-3">
        <div class="card">
            <div class="card-body summary-stat">
                <h3 id="stat-ai" class="text-info">-</h3>
                <p>AIè¯Šæ–­æ•°</p>
            </div>
        </div>
    </div>
</div>

<!-- ä¸»è¦å†…å®¹åŒºåŸŸ -->
<div class="row" id="main-content" style="display: none;">
    <!-- å·¦ä¾§ï¼šé«˜é£é™©äººå‘˜åˆ—è¡¨ -->
    <div class="col-lg-8 mb-4">
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">é«˜é£é™©äººå‘˜æ’å</h5>
                <span class="badge bg-secondary" id="list-count">0 äºº</span>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-hover employee-table">
                        <thead>
                            <tr>
                                <th style="width: 50px;">æ’å</th>
                                <th>å§“å</th>
                                <th style="width: 80px;">é£é™©åˆ†</th>
                                <th style="width: 100px;">ç»©æ•ˆè¶‹åŠ¿</th>
                                <th>é£é™©å› ç´ </th>
                                <th style="width: 80px;">çŠ¶æ€</th>
                                <th style="width: 120px;">æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody id="risk-table">
                            <tr>
                                <td colspan="7" class="text-center text-muted">
                                    è¯·ç‚¹å‡»"å¼€å§‹é£é™©åˆ†æ"æŒ‰é’®
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- å³ä¾§ï¼šè¯äº‘å’Œç”Ÿå­˜æ›²çº¿ -->
    <div class="col-lg-4">
        <!-- å…³é”®è¯è¯äº‘ -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="mb-0">é—®é¢˜å…³é”®è¯</h5>
            </div>
            <div class="card-body">
                <div class="wordcloud-container" id="wordcloud">
                    <span class="text-muted">æš‚æ— æ•°æ®</span>
                </div>
            </div>
        </div>

        <!-- ç”Ÿå­˜æ›²çº¿ -->
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">è¿ç« é£é™©æ›²çº¿</h5>
                <small class="text-muted">é©¾é©¶å¹´é™ä¸æ— è¿ç« æ¦‚ç‡</small>
            </div>
            <div class="card-body">
                <div class="survival-chart" id="survival-chart">
                    <canvas id="survival-canvas"></canvas>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- è¯¦æƒ…æ¨¡æ€æ¡† -->
<div class="modal fade" id="detail-modal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">å‘˜å·¥é£é™©è¯¦æƒ…</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="detail-content">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">å…³é—­</button>
                <a href="#" class="btn btn-primary" id="view-profile-btn">æŸ¥çœ‹å®Œæ•´ç”»åƒ</a>
            </div>
        </div>
    </div>
</div>

<!-- åŠ è½½é®ç½© -->
<div class="loading-overlay" id="loading" style="display: none;">
    <div class="text-center">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">Loading...</span>
        </div>
        <p class="text-muted">æ­£åœ¨è¿›è¡Œé£é™©åˆ†æï¼Œè¯·ç¨å€™...</p>
        <small class="text-muted">åˆ†æåŒ…å«æœºå™¨å­¦ä¹ ç®—æ³•è®¡ç®—ï¼Œå¯èƒ½éœ€è¦å‡ ç§’é’Ÿ</small>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>
<script src="{{ url_for('static', filename='js/chartjs-theme.js') }}"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Set default dates (last 12 months)
    const now = new Date();
    const endDate = now.toISOString().slice(0, 7);
    const startDate = new Date(now.setMonth(now.getMonth() - 12)).toISOString().slice(0, 7);

    document.getElementById('start-date').value = startDate;
    document.getElementById('end-date').value = endDate;

    let survivalChart = null;
    let analysisData = null;

    // Analyze button click (çœTokenæ¨¡å¼ï¼šä¸æ‰¹é‡è°ƒç”¨AI)
    document.getElementById('analyze-btn').addEventListener('click', async function() {
        const startDateVal = document.getElementById('start-date').value;
        const endDateVal = document.getElementById('end-date').value;

        // Show loading
        document.getElementById('loading').style.display = 'flex';

        try {
            // ç¦ç”¨æ‰¹é‡AIï¼Œä»…è¿›è¡Œç®—æ³•åˆ†æï¼ˆå…è´¹ï¼‰
            const params = new URLSearchParams({
                start_date: startDateVal,
                end_date: endDateVal,
                enable_ai: 'false'  // å§‹ç»ˆç¦ç”¨æ‰¹é‡AI
            });

            const resp = await fetch(`/personnel/api/risk-mining?${params}`);
            const data = await resp.json();

            if (data.success) {
                analysisData = data;
                renderResults(data);
            } else {
                alert('åˆ†æå¤±è´¥: ' + data.error);
            }
        } catch (e) {
            console.error('Analysis failed:', e);
            alert('åˆ†æè¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
        } finally {
            document.getElementById('loading').style.display = 'none';
        }
    });

    // Render all results
    function renderResults(data) {
        // Show content sections
        document.getElementById('summary-row').style.display = 'flex';
        document.getElementById('main-content').style.display = 'flex';

        // Update summary stats
        document.getElementById('stat-total').textContent = data.summary.total_employees;
        document.getElementById('stat-high-risk').textContent = data.summary.high_risk_count;
        document.getElementById('stat-anomaly').textContent = data.summary.anomaly_count;
        document.getElementById('stat-ai').textContent = data.summary.ai_diagnoses_performed || 0;

        // Render risk table
        renderRiskTable(data.high_risk_list);

        // Render wordcloud
        renderWordcloud(data.keyword_cloud);

        // Render survival chart
        renderSurvivalChart(data.survival_curve);
    }

    // Render risk table (çœTokenæ¨¡å¼ï¼šé«˜é£é™©äººå‘˜æ˜¾ç¤ºAIæŒ‰é’®)
    function renderRiskTable(employees) {
        const tbody = document.getElementById('risk-table');
        document.getElementById('list-count').textContent = employees.length + ' äºº';

        if (!employees.length) {
            tbody.innerHTML = '<tr><td colspan="7" class="text-center text-muted">æ— æ•°æ®</td></tr>';
            return;
        }

        // è®¡ç®—æ€»äººæ•°ç”¨äºåˆ¤æ–­å‰5%
        const totalEmployees = analysisData?.summary?.total_employees || employees.length;
        const top5PercentThreshold = Math.ceil(totalEmployees * 0.05);

        tbody.innerHTML = employees.map((emp, idx) => {
            const riskClass = emp.risk_score >= 80 ? 'risk-high' :
                             emp.risk_score >= 50 ? 'risk-medium' : 'risk-low';

            const slopeIcon = emp.performance_slope < -0.5 ? 'ğŸ“‰' :
                             emp.performance_slope < 0 ? 'â†˜ï¸' :
                             emp.performance_slope > 0.5 ? 'ğŸ“ˆ' : 'â¡ï¸';

            const factors = emp.risk_factors.map(f =>
                `<span class="factor-tag">${escapeHtml(f)}</span>`
            ).join('');

            const badges = [];
            if (emp.is_anomaly) badges.push('<span class="badge anomaly-badge">å¼‚å¸¸</span>');
            if (emp.ai_diagnosis) badges.push('<span class="badge bg-warning text-dark">AI</span>');

            // ä¸åç«¯ä¸€è‡´çš„é€»è¾‘ï¼šé£é™©åˆ†>=80 æˆ– æ’ååœ¨å‰5% æ‰æ˜¾ç¤ºAIè¯Šæ–­æŒ‰é’®
            const rank = idx + 1;
            const isHighRisk = emp.risk_score >= 80;
            const isTop5Percent = rank <= top5PercentThreshold;
            const shouldShowAiBtn = isHighRisk || isTop5Percent;

            let actionBtn = '';
            if (shouldShowAiBtn) {
                actionBtn = `<button class="btn btn-sm btn-outline-danger ai-diagnose-btn"
                              data-emp="${encodeURIComponent(JSON.stringify(emp))}"
                              onclick="event.stopPropagation(); triggerAIDiagnosis(this);">
                              ğŸ¤– AIè¯Šæ–­
                            </button>`;
            } else {
                actionBtn = '<span class="text-muted small">é£é™©æ­£å¸¸</span>';
            }

            return `
                <tr class="risk-row" data-emp="${encodeURIComponent(JSON.stringify(emp))}" style="cursor: pointer;">
                    <td><strong>${idx + 1}</strong></td>
                    <td>
                        <strong>${escapeHtml(emp.name)}</strong>
                        <br><small class="text-muted">${escapeHtml(emp.emp_no)}</small>
                    </td>
                    <td>
                        <span class="risk-score ${riskClass}">${emp.risk_score}</span>
                    </td>
                    <td>
                        <span title="æ–œç‡: ${emp.performance_slope.toFixed(3)}">${slopeIcon}</span>
                        <small class="text-muted">${emp.performance_slope.toFixed(2)}</small>
                    </td>
                    <td>${factors || '<span class="text-muted">-</span>'}</td>
                    <td>${badges.join(' ') || '-'}</td>
                    <td>${actionBtn}</td>
                </tr>
            `;
        }).join('');

        // Bind row clicks (not for AI button)
        tbody.querySelectorAll('.risk-row').forEach(row => {
            row.addEventListener('click', function(e) {
                // å¦‚æœç‚¹å‡»çš„æ˜¯AIæŒ‰é’®ï¼Œä¸è§¦å‘è¡Œç‚¹å‡»
                if (e.target.closest('.ai-diagnose-btn')) return;
                const emp = JSON.parse(decodeURIComponent(this.dataset.emp));
                showDetail(emp);
            });
        });
    }

    // Render wordcloud
    function renderWordcloud(keywords) {
        const container = document.getElementById('wordcloud');

        if (!keywords || !keywords.length) {
            container.innerHTML = '<span class="text-muted">æš‚æ— å…³é”®è¯æ•°æ®</span>';
            return;
        }

        const maxValue = Math.max(...keywords.map(k => k.value));
        const minValue = Math.min(...keywords.map(k => k.value));

        container.innerHTML = keywords.map(k => {
            const ratio = maxValue === minValue ? 0.5 :
                         (k.value - minValue) / (maxValue - minValue);
            const fontSize = 0.8 + ratio * 1.2; // 0.8rem to 2rem
            const opacity = 0.5 + ratio * 0.5;

            return `<span class="wordcloud-word" style="font-size: ${fontSize}rem; opacity: ${opacity};"
                         title="å‡ºç° ${k.value} æ¬¡">${escapeHtml(k.name)}</span>`;
        }).join('');
    }

    // Render survival chart
    function renderSurvivalChart(curveData) {
        const ctx = document.getElementById('survival-canvas').getContext('2d');

        if (survivalChart) {
            survivalChart.destroy();
        }

        if (!curveData || curveData.length < 2) {
            document.getElementById('survival-chart').innerHTML =
                '<div class="text-center text-muted py-5">æ•°æ®ä¸è¶³ï¼Œæ— æ³•ç”Ÿæˆæ›²çº¿</div>';
            return;
        }

        survivalChart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: curveData.map(d => d.time + 'å¹´'),
                datasets: [{
                    label: 'æ— è¿ç« æ¦‚ç‡',
                    data: curveData.map(d => d.probability * 100),
                    borderColor: '#0d6efd',
                    backgroundColor: 'rgba(13, 110, 253, 0.1)',
                    fill: true,
                    tension: 0.4
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: {
                        display: false
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `æ— è¿ç« æ¦‚ç‡: ${context.raw.toFixed(1)}%`;
                            }
                        }
                    }
                },
                scales: {
                    y: {
                        min: 0,
                        max: 100,
                        title: {
                            display: true,
                            text: 'æ— è¿ç« æ¦‚ç‡ (%)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'é©¾é©¶å¹´é™'
                        }
                    }
                }
            }
        });
    }

    // Show employee detail modal (æš´éœ²ä¸ºå…¨å±€å‡½æ•°ä¾›AIè¯Šæ–­ä½¿ç”¨)
    window.showDetailGlobal = showDetail;
    function showDetail(emp) {
        const modal = new bootstrap.Modal(document.getElementById('detail-modal'));

        const riskClass = emp.risk_score >= 80 ? 'risk-high' :
                         emp.risk_score >= 50 ? 'risk-medium' : 'risk-low';

        let html = `
            <div class="row mb-4">
                <div class="col-md-6">
                    <h6>åŸºæœ¬ä¿¡æ¯</h6>
                    <p><strong>å§“åï¼š</strong>${escapeHtml(emp.name)}</p>
                    <p><strong>å·¥å·ï¼š</strong>${escapeHtml(emp.emp_no)}</p>
                </div>
                <div class="col-md-6 text-center">
                    <h6>ç»¼åˆé£é™©è¯„åˆ†</h6>
                    <div class="risk-score ${riskClass}" style="font-size: 3rem;">${emp.risk_score}</div>
                </div>
            </div>

            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6>å®‰å…¨ç»´åº¦</h6>
                            <h4>${emp.safety_score}</h4>
                            <small class="text-muted">éšæ‚£ ${emp.safety_count} æ¬¡</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6>åŸ¹è®­ç»´åº¦</h6>
                            <h4>${emp.training_score}</h4>
                            <small class="text-muted">ä¸åˆæ ¼ ${emp.training_disqualified_count} æ¬¡</small>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card">
                        <div class="card-body text-center">
                            <h6>ç»©æ•ˆè¶‹åŠ¿</h6>
                            <h4>${emp.performance_slope >= 0 ? 'â†—ï¸' : 'â†˜ï¸'} ${emp.performance_slope.toFixed(2)}</h4>
                            <small class="text-muted">å‡åˆ† ${emp.performance_score}</small>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mb-4">
                <h6>é£é™©å› ç´ </h6>
                <div>
                    ${emp.risk_factors.length ?
                        emp.risk_factors.map(f => `<span class="factor-tag">${escapeHtml(f)}</span>`).join('') :
                        '<span class="text-muted">æ— æ˜æ˜¾é£é™©å› ç´ </span>'}
                </div>
            </div>

            ${emp.is_anomaly ? `
            <div class="alert alert-warning">
                <strong>å­¤ç«‹æ£®æ—æ£€æµ‹ï¼š</strong>è¯¥å‘˜å·¥æ•°æ®æ¨¡å¼æ˜¾ç¤ºå¼‚å¸¸ï¼ˆå¼‚å¸¸åˆ†æ•°: ${emp.anomaly_score}ï¼‰
            </div>
            ` : ''}

            ${emp.ai_diagnosis ? renderAIDiagnosis(emp) : ''}
        `;

        document.getElementById('detail-content').innerHTML = html;
        document.getElementById('view-profile-btn').href =
            `/personnel/capability-profile?emp_no=${encodeURIComponent(emp.emp_no)}`;

        modal.show();
    }

    // Escape HTML
    function escapeHtml(text) {
        if (!text) return '';
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    // Try to extract fields from malformed JSON string using regex
    function tryExtractFields(text) {
        if (!text) return null;

        try {
            const result = {};

            // Helper: extract string value after key (handles escaped quotes)
            function extractValue(key) {
                // Match "key": "value" pattern, allowing for escaped quotes inside value
                const regex = new RegExp('"' + key + '"\\s*:\\s*"((?:[^"\\\\]|\\\\.)*)"');
                const match = text.match(regex);
                return match ? match[1].replace(/\\"/g, '"').replace(/\\n/g, '\n') : null;
            }

            // Helper: extract array of strings
            function extractStringArray(key) {
                const regex = new RegExp('"' + key + '"\\s*:\\s*\\[([\\s\\S]*?)\\]');
                const match = text.match(regex);
                if (!match) return null;

                const items = [];
                // Match each string in the array
                const strRegex = /"((?:[^"\\]|\\.)*)"/g;
                let m;
                while ((m = strRegex.exec(match[1])) !== null) {
                    items.push(m[1].replace(/\\"/g, '"').replace(/\\n/g, '\n'));
                }
                return items.length > 0 ? items : null;
            }

            // Extract simple string fields
            result.summary = extractValue('summary');
            result.root_cause_type = extractValue('root_cause_type');
            result.root_cause_analysis = extractValue('root_cause_analysis');
            result.prediction = extractValue('prediction');
            result.training_gap = extractValue('training_gap');
            result.time_pattern = extractValue('time_pattern');

            // Extract string arrays
            result.frequent_issues = extractStringArray('frequent_issues');
            result.measures = extractStringArray('measures');

            // Extract severe_issues (array of objects)
            const severeMatch = text.match(/"severe_issues"\s*:\s*\[([\s\S]*?)\]/);
            if (severeMatch) {
                const issues = [];
                const issueRegex = /"issue"\s*:\s*"((?:[^"\\]|\\.)*)"/g;
                let m;
                while ((m = issueRegex.exec(severeMatch[1])) !== null) {
                    issues.push(m[1].replace(/\\"/g, '"'));
                }
                if (issues.length > 0) {
                    result.severe_issues = issues;
                }
            }

            // Clean up undefined values
            Object.keys(result).forEach(k => {
                if (result[k] === null || result[k] === undefined) {
                    delete result[k];
                }
            });

            // Check if we got at least summary or root_cause_type
            if (result.summary || result.root_cause_type || result.measures) {
                console.log('tryExtractFields succeeded:', result);
                return result;
            }
        } catch (e) {
            console.error('tryExtractFields error:', e);
        }

        return null;
    }

    // Render AI diagnosis in structured format with brief/detail toggle
    function renderAIDiagnosis(emp) {
        // Try to parse JSON from ai_diagnosis_parsed or ai_diagnosis
        let parsed = emp.ai_diagnosis_parsed;

        // If not parsed yet, try to parse from raw string
        if (!parsed && emp.ai_diagnosis) {
            try {
                // å°è¯•ç›´æ¥è§£æ
                let diagStr = emp.ai_diagnosis;

                // å¦‚æœæ˜¯å¯¹è±¡ï¼Œç›´æ¥ä½¿ç”¨
                if (typeof diagStr === 'object' && diagStr !== null) {
                    parsed = diagStr;
                } else {
                    // æ¸…ç†å­—ç¬¦ä¸²
                    diagStr = diagStr.trim();

                    // ç§»é™¤markdownä»£ç å—æ ‡è®°
                    if (diagStr.startsWith('```json')) {
                        diagStr = diagStr.substring(7);
                    }
                    if (diagStr.startsWith('```')) {
                        diagStr = diagStr.substring(3);
                    }
                    if (diagStr.endsWith('```')) {
                        diagStr = diagStr.slice(0, -3);
                    }
                    diagStr = diagStr.trim();

                    // æå–JSONå¯¹è±¡
                    const jsonMatch = diagStr.match(/\{[\s\S]*\}/);
                    if (jsonMatch) {
                        diagStr = jsonMatch[0];
                    }

                    parsed = JSON.parse(diagStr);
                }
            } catch (e) {
                console.error('AI diagnosis parse error:', e, emp.ai_diagnosis);
                // Fallback: å°è¯•æ‰‹åŠ¨æå–å…³é”®å­—æ®µ
                parsed = tryExtractFields(emp.ai_diagnosis);
            }
        }

        if (!parsed) {
            // æœ€ç»ˆfallbackï¼šæ˜¾ç¤ºåŸå§‹æ–‡æœ¬
            return `
                <div class="ai-diagnosis">
                    <div class="ai-diagnosis-header">ğŸ¤– AI æ™ºèƒ½è¯Šæ–­</div>
                    <div class="ai-section-content" style="white-space: pre-wrap;">${escapeHtml(emp.ai_diagnosis)}</div>
                </div>
            `;
        }

        const diagnosisId = 'ai-diag-' + emp.emp_no.replace(/[^a-zA-Z0-9]/g, '');

        // Build structured display with brief/detail modes
        let html = `<div class="ai-diagnosis">
            <div class="ai-diagnosis-header">ğŸ¤– AI æ™ºèƒ½è¯Šæ–­</div>
            <div class="ai-mode-toggle">
                <button class="ai-mode-btn" onclick="toggleAIDetail('${diagnosisId}', this)">
                    ğŸ“– å±•å¼€è¯¦æƒ…
                </button>
            </div>`;

        // ========== BRIEF MODE (Always visible) ==========
        html += `<div class="ai-brief-summary">`;

        // Summary/Conclusion
        if (parsed.summary) {
            html += `<div class="ai-brief-conclusion">
                <strong>ğŸ“‹ è¯Šæ–­ç»“è®ºï¼š</strong>${escapeHtml(parsed.summary)}
            </div>`;
        }

        // Root cause type (highlighted)
        if (parsed.root_cause_type) {
            const typeClass = parsed.root_cause_type.includes('æŠ€èƒ½') ? 'ai-root-skill' :
                             parsed.root_cause_type.includes('ä¹ æƒ¯') ? 'ai-root-habit' : 'ai-root-state';
            html += `<div class="ai-brief-row">
                <span class="ai-brief-label">ğŸ§  æ ¹å› ç±»å‹ï¼š</span>
                <span class="ai-root-type ${typeClass}">${escapeHtml(parsed.root_cause_type)}</span>
            </div>`;
        }

        // Key measures (brief)
        if (parsed.measures && parsed.measures.length > 0) {
            html += `<div style="margin-top: 0.5rem;">
                <span class="ai-brief-label">ğŸ’Š æ•´æ”¹æªæ–½ï¼š</span>
                <div style="margin-top: 0.25rem;">`;
            parsed.measures.slice(0, 3).forEach((measure, idx) => {
                html += `<div class="ai-measure">
                    <span class="ai-measure-icon">âœ“</span>
                    <span>${escapeHtml(measure)}</span>
                </div>`;
            });
            if (parsed.measures.length > 3) {
                html += `<small class="text-muted">...ç‚¹å‡»"å±•å¼€è¯¦æƒ…"æŸ¥çœ‹æ›´å¤š</small>`;
            }
            html += `</div></div>`;
        }

        html += `</div>`; // End brief summary

        // ========== DETAIL MODE (Toggle visibility) ==========
        html += `<div id="${diagnosisId}" class="ai-detail-section">`;

        // 1. Risk Profile - å…³é”®é£é™©ç”»åƒ
        html += `<div class="ai-section ai-section-risk">
            <div class="ai-section-title">ğŸš¨ å…³é”®é£é™©ç”»åƒ</div>
            <div class="ai-section-content">`;

        if (parsed.frequent_issues && parsed.frequent_issues.length > 0) {
            html += `<p><strong>é«˜é¢‘è¿ç« ç‚¹ï¼š</strong></p><div>`;
            parsed.frequent_issues.forEach(issue => {
                html += `<span class="ai-tag">${escapeHtml(issue)}</span>`;
            });
            html += `</div>`;
        }

        if (parsed.severe_issues && parsed.severe_issues.length > 0) {
            html += `<p style="margin-top: 0.5rem;"><strong>ä¸¥é‡è¿ç« ç‚¹ï¼š</strong></p><div>`;
            parsed.severe_issues.forEach(item => {
                const issue = typeof item === 'object' ? item.issue : item;
                const score = typeof item === 'object' ? item.score : '';
                html += `<span class="ai-tag ai-tag-severe">${escapeHtml(issue)}${score ? ' (' + score + ')' : ''}</span>`;
            });
            html += `</div>`;
        }

        if (parsed.time_pattern) {
            html += `<p style="margin-top: 0.5rem;"><strong>æ—¶ç©ºè§„å¾‹ï¼š</strong>${escapeHtml(parsed.time_pattern)}</p>`;
        }

        html += `</div></div>`;

        // 2. Training Gap - åŸ¹è®­å…³è”åˆ†æ
        if (parsed.training_gap) {
            html += `<div class="ai-section ai-section-training">
                <div class="ai-section-title">ğŸ“‰ åŸ¹è®­å…³è”åˆ†æ</div>
                <div class="ai-section-content">${escapeHtml(parsed.training_gap)}</div>
            </div>`;
        }

        // 3. Root Cause - æ ¹å› æ·±åº¦å®šæ€§ (Full version)
        if (parsed.root_cause_analysis) {
            html += `<div class="ai-section ai-section-root">
                <div class="ai-section-title">ğŸ§  æ ¹å› æ·±åº¦åˆ†æ</div>
                <div class="ai-section-content">${escapeHtml(parsed.root_cause_analysis)}</div>
            </div>`;
        }

        // 4. Prediction - é¢„æµ‹æ€§é¢„è­¦
        if (parsed.prediction) {
            html += `<div class="ai-section ai-section-predict">
                <div class="ai-section-title">ğŸ”® é¢„æµ‹æ€§é¢„è­¦</div>
                <div class="ai-section-content">${escapeHtml(parsed.prediction)}</div>
            </div>`;
        }

        // 5. Measures - ç²¾å‡†å¸®æ‰¶æ–¹æ¡ˆ (Full version)
        if (parsed.measures && parsed.measures.length > 3) {
            html += `<div class="ai-section ai-section-action">
                <div class="ai-section-title">ğŸ’Š å®Œæ•´å¸®æ‰¶æ–¹æ¡ˆ</div>
                <div class="ai-section-content">`;
            parsed.measures.forEach((measure, idx) => {
                html += `<div class="ai-measure">
                    <span class="ai-measure-icon">âœ“</span>
                    <span>${escapeHtml(measure)}</span>
                </div>`;
            });
            html += `</div></div>`;
        }

        html += `</div>`; // End detail section
        html += `</div>`; // End ai-diagnosis

        return html;
    }

});

// Toggle AI diagnosis detail view (global scope for onclick)
function toggleAIDetail(id, btn) {
    const detail = document.getElementById(id);
    if (detail.classList.contains('show')) {
        detail.classList.remove('show');
        btn.innerHTML = 'ğŸ“– å±•å¼€è¯¦æƒ…';
    } else {
        detail.classList.add('show');
        btn.innerHTML = 'ğŸ“• æ”¶èµ·è¯¦æƒ…';
    }
}

// å•ç‹¬è°ƒç”¨AIè¯Šæ–­ï¼ˆçœTokenæ¨¡å¼æ ¸å¿ƒï¼šå…ˆæŸ¥ç¼“å­˜ï¼Œæ— ç¼“å­˜æ‰è°ƒç”¨APIï¼‰
async function triggerAIDiagnosis(btn) {
    const emp = JSON.parse(decodeURIComponent(btn.dataset.emp));

    // è·å–å½“å‰é€‰æ‹©çš„æ—¥æœŸèŒƒå›´ï¼ˆå…³é”®ï¼šç¡®ä¿AIè¯Šæ–­ä½¿ç”¨ä¸ç”¨æˆ·ç­›é€‰ä¸€è‡´çš„æ•°æ®ï¼‰
    const startDate = document.getElementById('start-date').value;
    const endDate = document.getElementById('end-date').value;

    // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºåŠ è½½çŠ¶æ€
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = 'â³ åˆ†æä¸­...';

    try {
        const resp = await fetch('/personnel/api/ai-diagnosis', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({
                emp_no: emp.emp_no,
                name: emp.name,
                risk_score: emp.risk_score,
                // æ–°å¢ï¼šä¼ é€’æ—¥æœŸèŒƒå›´ï¼Œç¡®ä¿AIè¯Šæ–­æ•°æ®ä¸ç”¨æˆ·ç­›é€‰ä¸€è‡´
                start_date: startDate,
                end_date: endDate,
                risk_data: {
                    performance_slope: emp.performance_slope,
                    performance_score: emp.performance_score,
                    safety_score: emp.safety_score,
                    safety_count: emp.safety_count,
                    training_score: emp.training_score,
                    training_disqualified_count: emp.training_disqualified_count,
                    is_anomaly: emp.is_anomaly,
                    anomaly_score: emp.anomaly_score,
                    risk_factors: emp.risk_factors
                }
            })
        });

        const data = await resp.json();

        if (data.success) {
            // æ›´æ–°å‘˜å·¥æ•°æ®ï¼Œæ·»åŠ AIè¯Šæ–­ç»“æœ
            emp.ai_diagnosis = data.raw_diagnosis || data.diagnosis;
            emp.ai_diagnosis_parsed = typeof data.diagnosis === 'object' ? data.diagnosis : null;

            // æ˜¾ç¤ºæ¥æºå’ŒTokenæ¶ˆè€—ä¿¡æ¯
            const sourceText = data.source === 'cache' ? 'ğŸ“¦ æ¥è‡ªç¼“å­˜' : 'ğŸŒ æ–°APIè°ƒç”¨';
            const tokenText = data.tokens_used === 0 ? '0 Token (èŠ‚çœ!)' : `${data.tokens_used} Tokens`;

            // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
            btn.classList.remove('btn-outline-danger');
            btn.classList.add('btn-success');
            btn.innerHTML = `âœ… å·²è¯Šæ–­`;
            btn.title = `${sourceText} | ${tokenText}`;

            // å…³é”®ä¿®å¤ï¼šåŒæ—¶æ›´æ–°è¡¨æ ¼è¡Œå’ŒæŒ‰é’®çš„ data-emp å±æ€§ï¼Œä½¿ç‚¹å‡»è¡Œæ—¶èƒ½è·å–åˆ°AIè¯Šæ–­ç»“æœ
            const updatedEmpData = encodeURIComponent(JSON.stringify(emp));
            btn.dataset.emp = updatedEmpData;
            const row = btn.closest('tr.risk-row');
            if (row) {
                row.dataset.emp = updatedEmpData;
            }

            // å¼¹å‡ºè¯¦æƒ…æ¨¡æ€æ¡†æ˜¾ç¤ºè¯Šæ–­ç»“æœ
            showDetailWithDiagnosis(emp, data.source, data.tokens_used);

            // æ˜¾ç¤ºToasté€šçŸ¥
            showToast(`${sourceText} | ${tokenText}`, data.source === 'cache' ? 'success' : 'info');
        } else {
            btn.innerHTML = originalText;
            btn.disabled = false;
            alert('AIè¯Šæ–­å¤±è´¥: ' + data.error);
        }
    } catch (e) {
        console.error('AI diagnosis failed:', e);
        btn.innerHTML = originalText;
        btn.disabled = false;
        alert('AIè¯Šæ–­è¯·æ±‚å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥');
    }
}

// æ˜¾ç¤ºå¸¦è¯Šæ–­ç»“æœçš„è¯¦æƒ…æ¨¡æ€æ¡†
function showDetailWithDiagnosis(emp, source, tokensUsed) {
    // å¤ç”¨ç°æœ‰çš„showDetailé€»è¾‘ï¼Œä½†ä¼šæ˜¾ç¤ºAIè¯Šæ–­ç»“æœ
    // è·å–showDetailå‡½æ•°å¼•ç”¨ï¼ˆéœ€è¦åœ¨DOMContentLoadedå†…å®šä¹‰ä¸ºå…¨å±€ï¼‰
    if (window.showDetailGlobal) {
        window.showDetailGlobal(emp);
    } else {
        // Fallback: ç›´æ¥è§¦å‘æ¨¡æ€æ¡†
        const modal = new bootstrap.Modal(document.getElementById('detail-modal'));
        document.getElementById('detail-content').innerHTML = `
            <div class="alert ${source === 'cache' ? 'alert-success' : 'alert-info'}">
                <strong>æ•°æ®æ¥æºï¼š</strong>${source === 'cache' ? 'ğŸ“¦ ç¼“å­˜å‘½ä¸­ï¼ˆ0 Tokenï¼‰' : 'ğŸŒ æ–°APIè°ƒç”¨'}
                <br><strong>Tokenæ¶ˆè€—ï¼š</strong>${tokensUsed}
            </div>
            <div class="ai-diagnosis">
                <div class="ai-diagnosis-header">ğŸ¤– AI æ™ºèƒ½è¯Šæ–­</div>
                <pre style="white-space: pre-wrap;">${JSON.stringify(emp.ai_diagnosis_parsed || emp.ai_diagnosis, null, 2)}</pre>
            </div>
        `;
        modal.show();
    }
}

// æ˜¾ç¤ºToasté€šçŸ¥
function showToast(message, type) {
    // åˆ›å»ºç®€å•çš„toasté€šçŸ¥
    const toast = document.createElement('div');
    toast.className = `alert alert-${type} position-fixed`;
    toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; animation: fadeIn 0.3s;';
    toast.innerHTML = message;
    document.body.appendChild(toast);

    setTimeout(() => {
        toast.style.animation = 'fadeOut 0.3s';
        setTimeout(() => toast.remove(), 300);
    }, 3000);
}
</script>
{% endblock %}
