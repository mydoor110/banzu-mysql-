**角色设定：**
你是一名资深的算法工程师，精通工业安全风险预测与绩效评估模型。

**任务目标：**
请对 `EvaluationService` 中的 **稳定度 (Stability)** 和 **学习能力 (Learning Potential)** 核心算法进行重构。
我们需要抛弃旧的硬编码逻辑，实施一套 **“基于动态水位与趋势分类的风险预测模型”**。

**核心原则：**

1. **数据驱动 (Data-Driven):** 所有的基准线（如班组平均值、波动率）必须由系统根据当月数据实时计算，禁止使用写死的固定阈值。
2. **动态配置 (Configurable):** 所有的倍率、权重、奖惩系数必须通过 Config 类传入，支持一键切换管理模式（如“严管模式”或“成长模式”）。
3. **纯数量趋势 (Pure Quantitative Trend):** 学习能力只关注违规数量的变化趋势 () 和相对位置，**不进行**违规内容的文本语义比对。
4. **分级处理 (Tiered Processing):** 针对数据不足的新员工和数据充足的老员工，必须有自动降级 (Fallback) 机制。

---

### 1. 配置类定义 (EvaluationConfig)

请定义 `EvaluationConfig` 类，包含以下关键参数（括号内为默认值）：

* **稳定度参数：**
* `base_stability`: 基础分 (100.0)
* `violation_penalty`: 单次违规扣分 (10.0)
* `redline_penalty`: 红线违规扣分 (40.0)
* `safety_cv_limit`: 安全波动敏感系数 (1.2) —— *用于判定安全表现是否比综合表现更不稳定*。


* **学习能力参数 (动态水位控制):**
* `trend_warning_ratio`: 关注线倍率 (1.5) —— *即：超过班组平均值的 1.5 倍视为关注对象*。
* `trend_warning_floor`: 关注线保底值 (2) —— *即：无论班组平均值多低，至少达到 2 个才开始计算关注*。
* `trend_critical_ratio`: 熔断线倍率 (3.0)。
* `trend_critical_floor`: 熔断线保底值 (5)。


* **趋势奖惩系数:**
* `factor_improvement`: 改善 (数量下降) 的奖励系数 (1.2)。
* `factor_solidification`: 固化 (高位持平) 的惩罚系数 (0.4)。
* `factor_deterioration`: 恶化 (高位上升) 的惩罚系数 (0.0)。



---

### 2. 算法一：稳定度 (Stability)

**公式逻辑：** 

**执行步骤：**

1. **基础扣分 ():**
* 读取当月违规数据。
* 若含 **红线违规**，扣除 `redline_penalty`。
* 无论是否有红线，每发生一次违规，额外扣除 `violation_penalty`。
* *约束：* 基础分最低为 0。


2. **波动率修正 () —— 仅当历史数据  3个月时启用:**
* 系统自动计算过去 12 个月的 **安全评分 CV** () 和 **综合评分 CV** ()。
* **判定：** 若 。
* **动作：** 判定为“隐性不稳定”，强制将最终得分封顶在 **60分** (取 `min(Current_Score, 60)` )。


3. **冷启动保护:**
* 若历史数据不足 3 个月，跳过波动率修正，仅输出基础扣分结果。



---

### 3. 算法二：学习能力 (Learning Potential)

**核心逻辑：** 动态水位线 + 趋势分类 () + 群体校准。

**执行步骤：**

1. **计算动态水位线 (Dynamic Thresholds):**
* `Warning_Line` = 
* `Critical_Line` = 
* *注：Group_Avg 为系统自动计算的当月班组平均违规数。*


2. **熔断判定:**
* 若 `Current_Count`  `Critical_Line`  得分直接为 **0.0** (高风险熔断)。


3. **安全区判定:**
* 若 `Current_Count` < `Warning_Line` 且 `Last_Count` < `Warning_Line`  得分 **90.0** (低位波动，视为优秀)。


4. **高位趋势判定 (仅当不满足上述条件时):**
* 计算 
* **恶化** (): 系数 = `factor_deterioration` (0.0)
* **固化** (): 系数 = `factor_solidification` (0.4)
* **改善** (): 系数 = `factor_improvement` (1.2)


5. **群体相对校准 (Group Calibration):**
* *目的：消除外部环境因素（如大检查、设备故障）的影响。*
* 若被判定为“恶化”或“固化”，但 `Current_Count`  `Group_Avg`  系数 **+0.2** (优于大盘，给予回血)。
* 若 `Current_Count` > `Group_Avg`   系数 **** (显著差于大盘，加重惩罚)。


6. **最终计算:**
* 得分 = 。
* *冷启动逻辑：* 若无上月数据，本月无违规给 85 分，有违规给 70 分。
* *老员工保护：* 若历史  6个月且长期平均违规 ，若本月得分 ，强制加 **15分** 豁免值。



---

### 4. 聚合策略 (Aggregation Strategy)

请实现一个 `calculate_period_score` 方法，处理用户选择长周期（如年度）时的逻辑：

* **禁止** 将长时间段内的违规汇总后算一次公式。
* **必须** 遍历该时间段内的每个月，分别调用上述两个算法计算“单月得分”。
* **必须** 对单月得分进行 **时间加权平均** (Time-Weighted Average)，近期月份权重更高（例如采用线性递增权重），以反映员工最近的状态变化。

---
